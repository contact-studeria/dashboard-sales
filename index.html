<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Studeria â€” Sales Dashboard 2026</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0e1a; color: #e2e8f0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-font-smoothing: antialiased; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
  ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.3); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }
  input:focus { outline: none; }
  .tab-btn { padding: 8px 20px; border-radius: 10px; border: none; font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.2s ease; }
  .tab-btn.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; font-weight: 700; box-shadow: 0 4px 15px rgba(99,102,241,0.35); }
  .tab-btn:not(.active) { background: rgba(255,255,255,0.04); color: #94a3b8; font-weight: 500; border: 1px solid rgba(255,255,255,0.08); }
  .tab-btn:not(.active):hover { background: rgba(255,255,255,0.08); color: #e2e8f0; border-color: rgba(99,102,241,0.3); }
  .view-btn { padding: 5px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); font-size: 11px; cursor: pointer; font-family: inherit; transition: all 0.15s ease; font-weight: 500; }
  .view-btn.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border-color: transparent; box-shadow: 0 2px 8px rgba(99,102,241,0.3); }
  .view-btn:not(.active) { background: rgba(255,255,255,0.04); color: #94a3b8; }
  .view-btn:not(.active):hover { background: rgba(255,255,255,0.08); color: #e2e8f0; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
<script crossorigin src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;
const { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, Legend, PieChart, Pie, Cell: PieCell } = Recharts;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// CONSTANTS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const MONTHS = ["JAN","FÃ‰V","MAR","AVR","MAI","JUIN","JUIL","AOÃ›T","SEP","OCT","NOV","DÃ‰C"];
const CURRENT_MONTH = 1; // FÃ©vrier

const SOURCES = ["Maformation", "Meta", "Google"];
const SOURCE_COLORS = { Maformation: "#a855f7", Meta: "#818cf8", Google: "#34d399" };
const SOURCE_EMOJI = { Maformation: "ðŸ“‹", Meta: "ðŸ“±", Google: "ðŸ”" };

// Setters from HubSpot SETTING STUDERIA 2026 DAILY (contacts)
const SETTERS = [
  { id: "87794914", name: "BenoÃ®t", fullName: "Benoit Studeria", color: "#818cf8", leads: 443 },
  { id: "87991143", name: "Andria", fullName: "Andriamihamina Studeria", color: "#22d3ee", leads: 288 },
];

// Closers from HubSpot CLOSING STUDERIA 2026 DAILY (deals)
const CLOSERS = [
  { id: "76258488", name: "Hector", fullName: "Hector Studeria", color: "#34d399" },
  { id: "87679708", name: "Alexandre", fullName: "Alexandre Studeria", color: "#818cf8" },
  { id: "87679709", name: "Riad", fullName: "Riad Studeria", color: "#a855f7" },
  { id: "87679707", name: "Lionel", fullName: "Lionel Studeria", color: "#fbbf24" },
  { id: "88235026", name: "Emilienne", fullName: "Emilienne Studeria", color: "#22d3ee" },
  { id: "76836328", name: "Oscar", fullName: "Oscar Berger", color: "#fb923c" },
  { id: "76839536", name: "Matthieu", fullName: "Matthieu Baranez", color: "#f87171" },
  { id: "83252713", name: "ClÃ©ment", fullName: "ClÃ©ment Studeria", color: "#c084fc" },
];

// Closing pipeline stages
const STAGES = {
  r1_booke: "1290057281", r1_noshow: "1290057283",
  r2_booke: "1290057284", r2_noshow: "1290057285",
  followup_court: "1290057286", followup_long: "1290057292",
  deal_perdu: "1290057293", contrat_signe: "1290057288",
  acompte: "1290057289", cash: "1290057290", deal_gagne: "1290057291",
};

// Setting pipeline stages
const SETTING_STAGES = {
  lead_funnel: "1294068081", lead_prioritaire: "1300671024",
  nouveaux_leads: "1291941662", nrp1: "1291941663",
  nrp2: "1291941664", nrp3: "1291941665",
  nurturing: "1292501787", qualifie: "1292501786",
  disqualifie: "1291941668",
};

const C = {
  bg: "#0a0e1a", card: "#111827", accent: "#818cf8",
  green: "#34d399", red: "#f87171", blue: "#818cf8", yellow: "#fbbf24",
  text: "#f1f5f9", dim: "#94a3b8", muted: "#64748b",
  cyan: "#22d3ee", orange: "#fb923c", purple: "#a855f7",
  border: "rgba(255,255,255,0.08)", cardShadow: "0 4px 20px rgba(0,0,0,0.3), 0 0 1px rgba(255,255,255,0.05)",
  glow: (color) => `0 0 20px ${color}33, 0 4px 20px rgba(0,0,0,0.3)`,
  cardBg: "rgba(17,24,39,0.8)",
  gradientAccent: "linear-gradient(135deg, #6366f1, #8b5cf6)",
  gradientGreen: "linear-gradient(135deg, #059669, #34d399)",
  gradientRed: "linear-gradient(135deg, #dc2626, #f87171)",
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// DAILY CLOSING DATA (Feb 2026, by date â†’ by closer)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const DAILY_CLOSING = {
  "2026-02-05": {"87679707":{"newDeals":3,"r1":3,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"_total":{"newDeals":3,"r1":3,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0}},
  "2026-02-06": {"87679708":{"newDeals":4,"r1":1,"noshow":2,"r2":1,"won":0,"lost":0,"ca":0,"fu":0},"87679709":{"newDeals":8,"r1":3,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":4},"87679707":{"newDeals":15,"r1":8,"noshow":2,"r2":3,"won":0,"lost":0,"ca":0,"fu":2},"83252713":{"newDeals":1,"r1":0,"noshow":0,"r2":0,"won":1,"lost":0,"ca":2990,"fu":0},"_total":{"newDeals":28,"r1":12,"noshow":5,"r2":4,"won":1,"lost":0,"ca":2990,"fu":6}},
  "2026-02-07": {"87679707":{"newDeals":7,"r1":5,"noshow":1,"r2":1,"won":0,"lost":0,"ca":0,"fu":0},"87679709":{"newDeals":2,"r1":1,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"87679708":{"newDeals":4,"r1":1,"noshow":0,"r2":0,"won":0,"lost":1,"ca":0,"fu":2},"_total":{"newDeals":13,"r1":7,"noshow":2,"r2":1,"won":0,"lost":1,"ca":0,"fu":2}},
  "2026-02-08": {"87679709":{"newDeals":5,"r1":2,"noshow":0,"r2":2,"won":0,"lost":1,"ca":0,"fu":0},"87679708":{"newDeals":4,"r1":0,"noshow":0,"r2":1,"won":1,"lost":1,"ca":6000,"fu":1},"87679707":{"newDeals":14,"r1":10,"noshow":2,"r2":2,"won":0,"lost":0,"ca":0,"fu":0},"_total":{"newDeals":23,"r1":12,"noshow":2,"r2":5,"won":1,"lost":2,"ca":6000,"fu":1}},
  "2026-02-09": {"87679709":{"newDeals":3,"r1":3,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76258488":{"newDeals":15,"r1":12,"noshow":1,"r2":0,"won":1,"lost":1,"ca":6000,"fu":0},"76839536":{"newDeals":1,"r1":0,"noshow":0,"r2":1,"won":0,"lost":0,"ca":0,"fu":0},"87679708":{"newDeals":5,"r1":3,"noshow":0,"r2":1,"won":0,"lost":0,"ca":0,"fu":1},"87679707":{"newDeals":2,"r1":2,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"_total":{"newDeals":26,"r1":20,"noshow":1,"r2":2,"won":1,"lost":1,"ca":6000,"fu":1}},
  "2026-02-10": {"76836328":{"newDeals":2,"r1":2,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"87679709":{"newDeals":5,"r1":3,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":1},"76839536":{"newDeals":1,"r1":0,"noshow":0,"r2":1,"won":0,"lost":0,"ca":0,"fu":0},"87679707":{"newDeals":2,"r1":1,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"87679708":{"newDeals":2,"r1":1,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76258488":{"newDeals":11,"r1":7,"noshow":2,"r2":0,"won":1,"lost":0,"ca":3000,"fu":1},"_total":{"newDeals":23,"r1":14,"noshow":5,"r2":1,"won":1,"lost":0,"ca":3000,"fu":2}},
  "2026-02-11": {"87679708":{"newDeals":6,"r1":4,"noshow":2,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76836328":{"newDeals":9,"r1":6,"noshow":1,"r2":2,"won":0,"lost":0,"ca":0,"fu":0},"76839536":{"newDeals":5,"r1":3,"noshow":1,"r2":1,"won":0,"lost":0,"ca":0,"fu":0},"87679709":{"newDeals":4,"r1":3,"noshow":1,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76258488":{"newDeals":4,"r1":4,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"_total":{"newDeals":28,"r1":20,"noshow":5,"r2":3,"won":0,"lost":0,"ca":0,"fu":0}},
  "2026-02-12": {"76839536":{"newDeals":2,"r1":2,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76258488":{"newDeals":2,"r1":2,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"76836328":{"newDeals":1,"r1":1,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0},"_total":{"newDeals":5,"r1":5,"noshow":0,"r2":0,"won":0,"lost":0,"ca":0,"fu":0}},
};
const DAILY_DATES = Object.keys(DAILY_CLOSING).sort();
const FEB_DAYS = Array.from({length: 28}, (_, i) => `2026-02-${String(i+1).padStart(2, '0')}`);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// CLOSING BY SOURCE (Feb 2026 â€” from HubSpot hs_tag_ids / Deal Tags)
// Updated 13/02/2026 â€” Priority: MAFORMATION(18879432) > Meta(22696678,22696670,22618868,22696664,18879366) > Google(18879431) > Autre
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const CLOSING_SOURCES = ["Meta", "Google", "Maformation", "Autre"];
const CLOSING_SOURCE_COLORS = { Maformation: "#a855f7", Google: "#34d399", Meta: "#818cf8", Autre: "#64748b" };
const CLOSING_SOURCE_EMOJI = { Maformation: "ðŸ“‹", Google: "ðŸ”", Meta: "ðŸ“±", Autre: "ðŸŒ" };

const CLOSING_BY_SOURCE = {
  "Meta": { totalDeals: 120, r1NoShow: 15, r1Effectues: 33, r2Bookes: 17, r2NoShow: 2, fuCourt: 3, fuLong: 4, dealsSigne: 2, caSigne: 9000, dealsPerdu: 5 },
  "Google": { totalDeals: 28, r1NoShow: 5, r1Effectues: 6, r2Bookes: 0, r2NoShow: 0, fuCourt: 2, fuLong: 3, dealsSigne: 1, caSigne: 6000, dealsPerdu: 0 },
  "Maformation": { totalDeals: 26, r1NoShow: 5, r1Effectues: 5, r2Bookes: 3, r2NoShow: 0, fuCourt: 1, fuLong: 0, dealsSigne: 1, caSigne: 3000, dealsPerdu: 0 },
  "Autre": { totalDeals: 12, r1NoShow: 1, r1Effectues: 3, r2Bookes: 0, r2NoShow: 0, fuCourt: 0, fuLong: 0, dealsSigne: 2, caSigne: 8990, dealsPerdu: 1 },
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// MEETINGS / PLANNING DATA (from HubSpot MEETING_EVENT)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const OWNER_MAP = {};
CLOSERS.forEach(c => { OWNER_MAP[c.id] = { ...c, role: "closer" }; });
SETTERS.forEach(s => { OWNER_MAP[s.id] = { ...s, role: "setter" }; });

const MEETINGS_DATA = {
  "2026-02-13": [
    { owner: "76258488", title: "Kateryna Bezyuk", start: "09:30", end: "10:00", outcome: "SCHEDULED", type: "R1" },
    { owner: "76258488", title: "ThÃ©rÃ¨se Gbenou", start: "10:15", end: "11:00", outcome: "SCHEDULED", type: "R1" },
    { owner: "76258488", title: "Valentin Mouton", start: "11:00", end: "11:45", outcome: "SCHEDULED", type: "R2" },
    { owner: "76258488", title: "JÃ©rÃ©my Poncet", start: "14:00", end: "14:45", outcome: "COMPLETED", type: "R1" },
    { owner: "76258488", title: "Mathieu Schiano", start: "15:00", end: "15:45", outcome: "COMPLETED", type: "R1" },
    { owner: "76258488", title: "Marc-Antoine Leroy", start: "16:00", end: "16:30", outcome: "SCHEDULED", type: "FU" },
    { owner: "76258488", title: "Eric Dupont", start: "17:00", end: "17:45", outcome: "NO_SHOW", type: "R1" },
    { owner: "87679708", title: "Sophie Martin", start: "09:00", end: "09:45", outcome: "COMPLETED", type: "R1" },
    { owner: "87679708", title: "Julie Renard", start: "10:00", end: "10:45", outcome: "COMPLETED", type: "R2" },
    { owner: "87679708", title: "Thomas Petit", start: "11:15", end: "12:00", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679708", title: "Caroline Blanc", start: "14:00", end: "14:45", outcome: "NO_SHOW", type: "R1" },
    { owner: "87679708", title: "David Moreau", start: "15:30", end: "16:15", outcome: "SCHEDULED", type: "FU" },
    { owner: "87679708", title: "Nicolas Bernard", start: "16:30", end: "17:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679709", title: "Patricia Lefevre", start: "09:15", end: "10:00", outcome: "COMPLETED", type: "R1" },
    { owner: "87679709", title: "Romain Garcia", start: "10:30", end: "11:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679709", title: "Sylvie Dubois", start: "11:30", end: "12:00", outcome: "COMPLETED", type: "R2" },
    { owner: "87679709", title: "Antoine Rousseau", start: "14:15", end: "15:00", outcome: "NO_SHOW", type: "R1" },
    { owner: "87679709", title: "Franck Lambert", start: "15:30", end: "16:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679709", title: "Marie-Claire Fontaine", start: "16:30", end: "17:00", outcome: "SCHEDULED", type: "FU" },
    { owner: "87679709", title: "Luc Mercier", start: "17:15", end: "18:00", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679707", title: "Isabelle Girard", start: "09:00", end: "09:45", outcome: "COMPLETED", type: "R1" },
    { owner: "87679707", title: "Philippe AndrÃ©", start: "10:00", end: "10:45", outcome: "COMPLETED", type: "R2" },
    { owner: "87679707", title: "StÃ©phane Roux", start: "11:00", end: "11:45", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679707", title: "Nathalie Morel", start: "13:30", end: "14:15", outcome: "NO_SHOW", type: "R1" },
    { owner: "87679707", title: "Christian Fournier", start: "14:30", end: "15:15", outcome: "COMPLETED", type: "R1" },
    { owner: "87679707", title: "VÃ©ronique Simon", start: "15:30", end: "16:15", outcome: "SCHEDULED", type: "R2" },
    { owner: "87679707", title: "Michel Laurent", start: "16:30", end: "17:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "87679707", title: "CÃ©line Bonnet", start: "17:30", end: "18:00", outcome: "SCHEDULED", type: "FU" },
    { owner: "88235026", title: "Arnaud Dupuy", start: "09:30", end: "10:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "88235026", title: "Sandrine Leroy", start: "10:30", end: "11:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "88235026", title: "Jean-Pierre Marchand", start: "11:30", end: "12:15", outcome: "COMPLETED", type: "R1" },
    { owner: "88235026", title: "Laurence Duval", start: "14:00", end: "14:45", outcome: "SCHEDULED", type: "R1" },
    { owner: "88235026", title: "BenoÃ®t Chevalier", start: "15:00", end: "15:45", outcome: "NO_SHOW", type: "R1" },
    { owner: "76836328", title: "Christophe Perrin", start: "09:00", end: "09:45", outcome: "COMPLETED", type: "R1" },
    { owner: "76836328", title: "Florence Clement", start: "10:00", end: "10:45", outcome: "SCHEDULED", type: "R1" },
    { owner: "76836328", title: "Guillaume Masson", start: "11:00", end: "11:45", outcome: "COMPLETED", type: "R2" },
    { owner: "76836328", title: "Audrey Garnier", start: "14:00", end: "14:45", outcome: "NO_SHOW", type: "R1" },
    { owner: "76836328", title: "SÃ©bastien Faure", start: "15:00", end: "15:45", outcome: "SCHEDULED", type: "R1" },
    { owner: "76836328", title: "HÃ©lÃ¨ne Picard", start: "16:00", end: "16:45", outcome: "SCHEDULED", type: "FU" },
    { owner: "76839536", title: "Vincent Lemoine", start: "09:15", end: "10:00", outcome: "COMPLETED", type: "R1" },
    { owner: "76839536", title: "Pauline Guerin", start: "10:15", end: "11:00", outcome: "SCHEDULED", type: "R1" },
    { owner: "76839536", title: "Damien Robin", start: "11:15", end: "12:00", outcome: "SCHEDULED", type: "R2" },
    { owner: "76839536", title: "Emilie Blanchard", start: "14:30", end: "15:15", outcome: "NO_SHOW", type: "R1" },
    { owner: "76839536", title: "Olivier Renaud", start: "15:30", end: "16:15", outcome: "SCHEDULED", type: "R1" },
    { owner: "83252713", title: "CÃ©dric Vasseur", start: "10:00", end: "10:45", outcome: "COMPLETED", type: "R1" },
    { owner: "83252713", title: "Margaux Delorme", start: "14:00", end: "14:45", outcome: "SCHEDULED", type: "R1" },
  ],
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// OBJECTIVES & PROJECTIONS (Feb 2026)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const OBJECTIVES = {
  tauxClosing: 10,       // 10% target
  tauxShowUp: 80,        // 80% show-up target
  tauxSetterRDV: 10,     // 10% optins â†’ R1 via setter
  panierMoyen: 4800,     // 40% Incubateur(3K) + 30% Consultant(6K) + 30% AccÃ©lÃ©rateur(6K)
  offreMix: { incubateur: 0.40, consultant: 0.30, accelerateur: 0.30 },
  offrePrix: { incubateur: 3000, consultant: 6000, accelerateur: 6000 },
};

// Projections par source (accordÃ©es avec marketing)
const PROJECTIONS = {
  Meta:         { r1Bookes: 930,  optins: 5200, hasVSL: true },
  Google:       { r1Bookes: 125,  optins: 400,  hasVSL: true },
  Maformation:  { r1Bookes: 0,    optins: 350,  hasVSL: false },
};

// Derived projections
const PROJ_TOTAL_R1_DIRECT = Object.values(PROJECTIONS).reduce((s, p) => s + p.r1Bookes, 0); // 1055
const PROJ_TOTAL_OPTINS = Object.values(PROJECTIONS).reduce((s, p) => s + p.optins, 0); // 5950
const PROJ_R1_VIA_SETTER = Math.round(PROJ_TOTAL_OPTINS * OBJECTIVES.tauxSetterRDV / 100); // ~595
const PROJ_TOTAL_R1 = PROJ_TOTAL_R1_DIRECT + PROJ_R1_VIA_SETTER; // ~1650
const PROJ_R1_EFFECTUES = Math.round(PROJ_TOTAL_R1 * OBJECTIVES.tauxShowUp / 100); // ~1320
const PROJ_DEALS_SIGNES = Math.round(PROJ_R1_EFFECTUES * OBJECTIVES.tauxClosing / 100); // ~132
const PROJ_CA_MENSUEL = PROJ_DEALS_SIGNES * OBJECTIVES.panierMoyen; // ~633,600â‚¬

// Pipe weights by stage (for pipe value calculation)
const PIPE_WEIGHTS = {
  "1290057281": 0.05,  // R1 BookÃ©
  "1290057283": 0.00,  // R1 No Show
  "1290057284": 0.25,  // R2 BookÃ©
  "1290057285": 0.00,  // R2 No Show
  "1290057286": 0.15,  // Follow-up Court
  "1290057292": 0.10,  // Follow-up Long
  "1290057293": 0.00,  // Deal Perdu
  "1290057291": 1.00,  // Deal GagnÃ©
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// HUBSPOT API â€” AUTO-REFRESH TOUTES LES HEURES
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const API_BASE = "";  // URLs relatives â€” mÃªme domaine sur Vercel
const REFRESH_INTERVAL_MS = 60 * 60 * 1000; // 1 heure

async function fetchAPI(endpoint) {
  const res = await fetch(API_BASE + endpoint);
  if (!res.ok) throw new Error("HTTP " + res.status);
  const json = await res.json();
  if (!json.success) throw new Error(json.error || "Erreur API");
  return json.data;
}

// Mapper les donnÃ©es Closing de l'API vers le format du dashboard
function mapClosingToState(apiData, prevClosing) {
  const mi = CURRENT_MONTH;
  const next = JSON.parse(JSON.stringify(prevClosing));
  if (!apiData || !apiData.owners) return next;

  CLOSERS.forEach(c => {
    const ow = apiData.owners[c.id];
    if (!ow) return;
    const bs = ow.by_stage || {};
    const total = ow.total || 0;
    const r1Booke = bs["R1 booke"] || 0;
    const r1NoShow = bs["R1 No Show / Annule"] || 0;
    const r2Booke = bs["R2 booke"] || 0;

    next[c.id].r1Bookes[mi] = total;
    next[c.id].r1NoShow[mi] = r1NoShow + (bs["R2 No Show / Annule"] || 0);
    next[c.id].r1Effectues[mi] = Math.max(0, total - r1Booke - r1NoShow);
    next[c.id].r2Bookes[mi] = r2Booke;
    next[c.id].dealsSigne[mi] = ow.won || 0;
    next[c.id].caSign[mi] = ow.revenue_won || 0;
    next[c.id].dealsPerdu[mi] = ow.lost || 0;
  });

  return next;
}

// Mapper les donnÃ©es Setting de l'API vers le format du dashboard
function mapSettingToState(apiData, prevSetters) {
  const mi = CURRENT_MONTH;
  const next = JSON.parse(JSON.stringify(prevSetters));
  if (!apiData || !apiData.owners) return next;

  SETTERS.forEach(s => {
    const ow = apiData.owners[s.id];
    if (!ow) return;
    next[s.id].leadsRecus[mi] = ow.total || 0;
    next[s.id].leadsQualifies[mi] = ow.qualified || 0;
    next[s.id].rdvBookes[mi] = ow.qualified || 0;
    next[s.id].disqualifies[mi] = ow.disqualified || 0;
  });

  return next;
}

// Mapper les sources closing de l'API (sourceByStage OR sourceBreakdown fallback)
function mapSourceClosing(apiData) {
  // Prefer the detailed sourceByStage (new endpoint data)
  if (apiData && apiData.sourceByStage) {
    return apiData.sourceByStage; // Already in the right format: { source: {totalDeals, r1NoShow, r1Effectues, ...} }
  }
  // Fallback: sourceBreakdown (less detail)
  if (!apiData || !apiData.sourceBreakdown) return null;
  const result = {};
  for (const [src, d] of Object.entries(apiData.sourceBreakdown)) {
    result[src] = {
      totalDeals: d.total || 0,
      dealsSigne: d.won || 0,
      caSigne: d.revenue_won || 0,
      r1NoShow: 0, r1Effectues: 0, r2Bookes: 0, r2NoShow: 0,
      fuCourt: 0, fuLong: 0, dealsPerdu: 0,
    };
  }
  return result;
}

// Mapper setter-metrics API vers le state setter
function mapSetterMetrics(metricsData, prevSetters) {
  const mi = CURRENT_MONTH;
  const next = JSON.parse(JSON.stringify(prevSetters));
  if (!metricsData) return next;

  SETTERS.forEach(s => {
    const m = metricsData[s.id];
    if (!m) return;
    const calls = m.calls || {};
    const rt = m.reactionTime || {};
    // Monthly breakdown for current month
    const monthCalls = (calls.byMonth || [])[mi] || {};
    const monthRT = (rt.byMonth || [])[mi] || {};

    next[s.id].appelsTotaux[mi] = monthCalls.total || calls.appelsTotaux || 0;
    next[s.id].appelsDecroches[mi] = monthCalls.connected || calls.appelsDecroches || 0;
    next[s.id].tempsReaction[mi] = monthRT.median_minutes || rt.median_minutes || 0;
  });

  return next;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// DATA STRUCTURE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const em = () => Array(12).fill(null);

function initialData() {
  const mkSetting = () => ({
    leads: em(), rdvBookes: em(), tauxPriseRdv: em(), tempsReaction: em(),
    appelsDecroches: em(), appelsTotaux: em(), r1Bookes: em(),
  });
  const mkCloser = () => ({
    r1Bookes: em(), r1NoShow: em(), r1Effectues: em(),
    r2Bookes: em(), dealsSigne: em(), caSign: em(), dealsPerdu: em(),
  });
  const mkSetter = () => ({
    leadsRecus: em(), leadsContactes: em(), leadsQualifies: em(),
    rdvBookes: em(), appelsDecroches: em(), appelsTotaux: em(),
    tempsReaction: em(), disqualifies: em(),
  });

  const closers = {};
  CLOSERS.forEach(c => { closers[c.id] = mkCloser(); });

  const setters = {};
  SETTERS.forEach(s => { setters[s.id] = mkSetter(); });

  // â”€â”€ INJECT REAL HUBSPOT DATA (Feb 2026 = index 1) â”€â”€
  const M = 1; // FÃ©vrier

  // CLOSING: Per-closer VERIFIED data from HubSpot pipeline 861971502 (13 fÃ©v 2026)
  // Hector (76258488): 38 deals total, 4 won, 18000â‚¬
  closers["76258488"].r1Bookes[M] = 38;
  closers["76258488"].r1NoShow[M] = 4;
  closers["76258488"].r1Effectues[M] = 6;
  closers["76258488"].r2Bookes[M] = 0;
  closers["76258488"].dealsSigne[M] = 4;
  closers["76258488"].caSign[M] = 18000;
  closers["76258488"].dealsPerdu[M] = 1;

  // Alexandre (87679708): 28 deals, 1 won, 6000â‚¬
  closers["87679708"].r1Bookes[M] = 28;
  closers["87679708"].r1NoShow[M] = 4;
  closers["87679708"].r1Effectues[M] = 12;
  closers["87679708"].r2Bookes[M] = 5;
  closers["87679708"].dealsSigne[M] = 1;
  closers["87679708"].caSign[M] = 6000;
  closers["87679708"].dealsPerdu[M] = 2;

  // Riad (87679709): 31 deals, 0 won
  closers["87679709"].r1Bookes[M] = 31;
  closers["87679709"].r1NoShow[M] = 5;
  closers["87679709"].r1Effectues[M] = 11;
  closers["87679709"].r2Bookes[M] = 3;
  closers["87679709"].dealsSigne[M] = 0;
  closers["87679709"].caSign[M] = 0;
  closers["87679709"].dealsPerdu[M] = 1;

  // Lionel (87679707): 43 deals, 0 won
  closers["87679707"].r1Bookes[M] = 43;
  closers["87679707"].r1NoShow[M] = 5;
  closers["87679707"].r1Effectues[M] = 8;
  closers["87679707"].r2Bookes[M] = 6;
  closers["87679707"].dealsSigne[M] = 0;
  closers["87679707"].caSign[M] = 0;
  closers["87679707"].dealsPerdu[M] = 0;

  // Emilienne (88235026): 14 deals, 0 won
  closers["88235026"].r1Bookes[M] = 14;
  closers["88235026"].r1NoShow[M] = 0;
  closers["88235026"].r1Effectues[M] = 0;
  closers["88235026"].r2Bookes[M] = 0;
  closers["88235026"].dealsSigne[M] = 0;
  closers["88235026"].caSign[M] = 0;
  closers["88235026"].dealsPerdu[M] = 0;

  // Oscar (76836328): 16 deals, 0 won
  closers["76836328"].r1Bookes[M] = 16;
  closers["76836328"].r1NoShow[M] = 1;
  closers["76836328"].r1Effectues[M] = 3;
  closers["76836328"].r2Bookes[M] = 2;
  closers["76836328"].dealsSigne[M] = 0;
  closers["76836328"].caSign[M] = 0;
  closers["76836328"].dealsPerdu[M] = 0;

  // Matthieu (76839536): 12 deals, 0 won
  closers["76839536"].r1Bookes[M] = 12;
  closers["76839536"].r1NoShow[M] = 1;
  closers["76839536"].r1Effectues[M] = 5;
  closers["76839536"].r2Bookes[M] = 5;
  closers["76839536"].dealsSigne[M] = 0;
  closers["76839536"].caSign[M] = 0;
  closers["76839536"].dealsPerdu[M] = 0;

  // ClÃ©ment (83252713): 1 deal, 1 won, 2990â‚¬
  closers["83252713"].r1Bookes[M] = 1;
  closers["83252713"].r1NoShow[M] = 0;
  closers["83252713"].r1Effectues[M] = 1;
  closers["83252713"].r2Bookes[M] = 0;
  closers["83252713"].dealsSigne[M] = 1;
  closers["83252713"].caSign[M] = 2990;
  closers["83252713"].dealsPerdu[M] = 0;

  // SETTING: Per-setter real data (Feb 2026)
  // BenoÃ®t (87794914): 443 contacts total
  setters["87794914"].leadsRecus[M] = 443;
  setters["87794914"].leadsContactes[M] = 234;  // num_contacted_notes > 0
  setters["87794914"].leadsQualifies[M] = 48;   // lifecycle=opportunity
  setters["87794914"].rdvBookes[M] = 48;         // num_associated_deals > 0
  setters["87794914"].appelsTotaux[M] = 365;     // calls from Ringover
  setters["87794914"].appelsDecroches[M] = 319;  // disposition=ConnectÃ©
  setters["87794914"].disqualifies[M] = 32;      // hs_latest_disqualified_lead_date
  setters["87794914"].tempsReaction[M] = 338;     // Median reaction time in minutes (from hs_time_to_first_engagement)

  // Andria (87991143): 288 contacts total
  setters["87991143"].leadsRecus[M] = 288;
  setters["87991143"].leadsContactes[M] = 247;  // num_contacted_notes > 0
  setters["87991143"].leadsQualifies[M] = 29;   // lifecycle=opportunity+customer
  setters["87991143"].rdvBookes[M] = 29;         // num_associated_deals > 0
  setters["87991143"].appelsTotaux[M] = 368;     // calls from Ringover
  setters["87991143"].appelsDecroches[M] = 302;  // disposition=ConnectÃ©
  setters["87991143"].disqualifies[M] = 11;      // hs_latest_disqualified_lead_date
  setters["87991143"].tempsReaction[M] = 613;     // Median reaction time in minutes (from hs_time_to_first_engagement)

  // SETTING: Per-source (extrapolated from 200-sample to full totals)
  // Maformation: ~93/200*443 + ~44/200*288 â‰ˆ 206 + 63 = ~269 total leads
  const settingMaf = mkSetting();
  settingMaf.leads[M] = 269;
  // Meta: ~96/200*443 + ~95/200*288 â‰ˆ 213 + 137 = ~350
  const settingMeta = mkSetting();
  settingMeta.leads[M] = 350;
  // Google: ~56/200*443 + ~53/200*288 â‰ˆ 124 + 76 = ~200
  const settingGoogle = mkSetting();
  settingGoogle.leads[M] = 200;

  return {
    setting: {
      bySource: { Maformation: settingMaf, Meta: settingMeta, Google: settingGoogle },
      bySetter: setters,
    },
    closing: closers,
  };
}

// LocalStorage
const LS = "studeria_sales_v9";
function save(d) { try { localStorage.setItem(LS, JSON.stringify(d)); } catch(e) {} }
function loadLS() { try { const r = localStorage.getItem(LS); return r ? JSON.parse(r) : null; } catch(e) { return null; } }

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FORMATTERS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const num = (n) => n == null ? "â€”" : new Intl.NumberFormat("fr-FR").format(n);
const euro = (n) => n == null ? "â€”" : new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR", maximumFractionDigits: 0 }).format(n);
const pct = (n) => n == null ? "â€”" : n.toFixed(1) + "%";
const sum = (arr) => arr.reduce((a, v) => a + (v || 0), 0);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// COMPONENTS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Editable cell
function EditCell({ value, onChange, format }) {
  const [editing, setEditing] = useState(false);
  const [tv, setTv] = useState("");
  const display = format === "euro" ? euro(value) : (value == null ? React.createElement('span', {style:{color:C.muted,opacity:0.5}}, "â€”") : num(value));
  if (editing) return (
    React.createElement('input', {
      autoFocus: true, type: "text", value: tv,
      onChange: e => setTv(e.target.value),
      onBlur: () => {
        setEditing(false);
        if (tv === "" || tv === "â€”") { onChange(null); return; }
        const p = parseFloat(tv.replace(/[^0-9.,\-]/g, "").replace(",", "."));
        onChange(isNaN(p) ? null : p);
      },
      onKeyDown: e => { if (e.key === "Enter") e.target.blur(); if (e.key === "Escape") setEditing(false); },
      style: { width: "100%", background: "rgba(99,102,241,0.1)", border: "1px solid rgba(99,102,241,0.4)", borderRadius: 6, color: "#f1f5f9", padding: "4px 6px", fontSize: 12, textAlign: "right", outline: "none", fontFamily: "inherit" }
    })
  );
  return (
    <div onClick={() => { setTv(value == null ? "" : String(value)); setEditing(true); }}
      style={{ cursor: "text", padding: "4px 6px", borderRadius: 4, textAlign: "right", minHeight: 24, fontSize: 12, color: C.text }}
      onMouseEnter={e => e.currentTarget.style.background = "rgba(255,255,255,0.04)"}
      onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
      {display}
    </div>
  );
}

// KPI card
function KPI({ label, value, sub, color = C.accent }) {
  return (
    <div style={{ background: C.card, borderRadius: 12, padding: "16px 18px", borderLeft: `3px solid ${color}`, boxShadow: C.cardShadow, border: "1px solid " + C.border }}>
      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", letterSpacing: "0.06em", fontWeight: 600, marginBottom: 6 }}>{label}</div>
      <div style={{ fontSize: 26, fontWeight: 800, color: C.text, lineHeight: 1.2 }}>{value}</div>
      {sub && <div style={{ fontSize: 11, color: C.muted, marginTop: 4 }}>{sub}</div>}
    </div>
  );
}

// Generic monthly table
function MonthlyTable({ title, titleColor, titleEmoji, rows, data, onCellChange }) {
  return (
    <div style={{ marginBottom: 24, background: C.card, borderRadius: 12, border: "1px solid " + C.border, boxShadow: C.cardShadow, overflow: "hidden" }}>
      {title && (
        <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "12px 16px", borderBottom: "1px solid " + C.border }}>
          {titleEmoji && <span style={{ fontSize: 16 }}>{titleEmoji}</span>}
          <span style={{ fontSize: 14, fontWeight: 700, color: titleColor || C.text }}>{title}</span>
        </div>
      )}
      <div style={{ overflowX: "auto" }}>
        <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
          <thead>
            <tr style={{ background: "rgba(255,255,255,0.03)" }}>
              <th style={{ padding: "10px 12px", textAlign: "left", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", letterSpacing: "0.06em", borderBottom: "1px solid " + C.border, minWidth: 130 }}>KPI</th>
              {MONTHS.map((m, i) => (
                <th key={i} style={{ padding: "10px 3px", textAlign: "right", fontWeight: 600, color: i === CURRENT_MONTH ? C.accent : C.muted, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border, minWidth: 56, background: i === CURRENT_MONTH ? "rgba(99,102,241,0.08)" : "transparent" }}>{m}</th>
              ))}
              <th style={{ padding: "10px 10px", textAlign: "right", fontWeight: 700, color: C.accent, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border, minWidth: 60 }}>TOTAL</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((row, ri) => (
              <tr key={row.key} style={{ borderBottom: ri < rows.length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none" }}>
                <td style={{ padding: "8px 12px", color: C.dim, fontWeight: 500, fontSize: 12 }}>{row.label}</td>
                {MONTHS.map((_, i) => (
                  <td key={i} style={{ padding: "2px 0", background: i === CURRENT_MONTH ? "rgba(99,102,241,0.06)" : "transparent" }}>
                    {row.computed
                      ? <div style={{ padding: "4px 6px", textAlign: "right", fontSize: 12, color: C.text }}>{row.computeFn(data, i)}</div>
                      : <EditCell value={data[row.key] && data[row.key][i]} onChange={v => onCellChange(row.key, i, v)} format={row.format} />
                    }
                  </td>
                ))}
                <td style={{ padding: "8px 10px", textAlign: "right", fontWeight: 700, color: C.accent, fontSize: 12 }}>
                  {row.computed ? "â€”" : (row.format === "euro" ? euro(sum(data[row.key] || [])) : num(sum(data[row.key] || [])))}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// Setter summary card
function SetterCard({ setter, data, mi }) {
  const d = data || {};
  const leads = (d.leadsRecus || [])[mi] || 0;
  const contactes = (d.leadsContactes || [])[mi] || 0;
  const qualifies = (d.leadsQualifies || [])[mi] || 0;
  const rdv = (d.rdvBookes || [])[mi] || 0;
  const appels = (d.appelsTotaux || [])[mi] || 0;
  const tempsReaction = (d.tempsReaction || [])[mi];
  const tauxQualif = leads > 0 ? (qualifies / leads * 100) : null;
  const tauxRdv = leads > 0 ? (rdv / leads * 100) : null;
  const formatReaction = (min) => {
    if (min == null) return "â€”";
    if (min < 60) return Math.round(min) + " min";
    const h = Math.floor(min / 60);
    const m = Math.round(min % 60);
    return h + "h" + (m > 0 ? m.toString().padStart(2, "0") : "");
  };

  return (
    <div style={{ background: C.card, borderRadius: 12, padding: "18px 20px", borderLeft: `4px solid ${setter.color}`, minWidth: 0, boxShadow: C.cardShadow, border: "1px solid " + C.border }}>
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
        <div style={{ width: 36, height: 36, borderRadius: "50%", background: setter.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 15, fontWeight: 700, color: setter.color }}>
          {setter.name[0]}
        </div>
        <div>
          <div style={{ fontSize: 15, fontWeight: 700, color: C.text }}>{setter.name}</div>
          <div style={{ fontSize: 11, color: C.muted }}>{setter.fullName}</div>
        </div>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "10px 14px" }}>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Leads reÃ§us</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: C.text }}>{leads || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>QualifiÃ©s</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: C.green }}>{qualifies || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>RDV bookÃ©s</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: C.accent }}>{rdv || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Appels</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: C.text }}>{appels || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Taux qualif.</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: tauxQualif != null ? (tauxQualif >= 30 ? C.green : C.yellow) : C.muted }}>{tauxQualif != null ? tauxQualif.toFixed(0) + "%" : "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Temps rÃ©action</div>
          <div style={{ fontSize: 22, fontWeight: 800, color: tempsReaction != null ? (tempsReaction <= 300 ? C.green : tempsReaction <= 600 ? C.yellow : C.red) : C.muted }}>{formatReaction(tempsReaction)}</div>
        </div>
      </div>
    </div>
  );
}

// Closer summary card
function CloserCard({ closer, data, mi }) {
  const d = data[closer.id] || {};
  const r1 = (d.r1Bookes || [])[mi] || 0;
  const noshow = (d.r1NoShow || [])[mi] || 0;
  const r1eff = (d.r1Effectues || [])[mi] || 0;
  const r2 = (d.r2Bookes || [])[mi] || 0;
  const deals = (d.dealsSigne || [])[mi] || 0;
  const ca = (d.caSign || [])[mi] || 0;
  const perdu = (d.dealsPerdu || [])[mi] || 0;
  const showUp = (r1eff + noshow) > 0 ? (r1eff / (r1eff + noshow) * 100) : null;
  const tauxClosing = r1eff > 0 ? (deals / r1eff * 100) : null;
  const panierMoyen = deals > 0 ? Math.round(ca / deals) : null;
  // Pipe value pondÃ©rÃ©e : R1 bookÃ©s(5%) + R2(25%) + FU(15%) - deals dÃ©jÃ  signÃ©s (100%) - perdus (0%)
  const fuCourt = r1 - r1eff - noshow - r2 - deals - perdu; // estimation restante
  const pipeDealsEnCours = r1 - deals - perdu;
  const pipeValue = pipeDealsEnCours > 0 ? Math.round(
    (r1eff * 0.05 + r2 * 0.25 + Math.max(0, fuCourt) * 0.15) * (panierMoyen || OBJECTIVES.panierMoyen)
  ) : 0;
  // Ratio R1 â†’ R2
  const ratioR1R2 = r1eff > 0 ? (r2 / r1eff * 100) : null;

  return (
    <div style={{ background: C.card, borderRadius: 12, padding: "18px 20px", borderLeft: `4px solid ${closer.color}`, minWidth: 0, boxShadow: C.cardShadow, border: "1px solid " + C.border }}>
      <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
        <div style={{ width: 32, height: 32, borderRadius: "50%", background: closer.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, fontWeight: 700, color: closer.color }}>
          {closer.name[0]}
        </div>
        <div style={{ display: "flex", flexDirection: "column" }}>
          <span style={{ fontSize: 15, fontWeight: 700, color: C.text }}>{closer.name}</span>
          {ca > 0 && <span style={{ fontSize: 11, color: C.accent, fontWeight: 600 }}>{euro(ca)}</span>}
        </div>
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 12px" }}>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Total deals</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: C.text }}>{r1 || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R1 effectuÃ©s</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: C.accent }}>{r1eff || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>No Show</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: noshow > 0 ? C.red : C.green }}>{noshow}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R2 bookÃ©s</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: C.cyan }}>{r2 || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Deals signÃ©s</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: deals > 0 ? C.green : C.muted }}>{deals || "â€”"}</div>
        </div>
        <div>
          <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Deals perdus</div>
          <div style={{ fontSize: 18, fontWeight: 800, color: perdu > 0 ? C.red : C.muted }}>{perdu || "â€”"}</div>
        </div>
      </div>
      {/* New KPI row: Taux closing + Panier moyen + Pipe value */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "6px 12px", marginTop: 10, paddingTop: 10, borderTop: "1px solid " + C.border }}>
        <div>
          <div style={{ fontSize: 9, color: C.muted, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Taux closing</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: tauxClosing != null ? (tauxClosing >= 20 ? C.green : tauxClosing >= 10 ? C.yellow : C.red) : C.muted }}>
            {tauxClosing != null ? tauxClosing.toFixed(1) + "%" : "â€”"}
          </div>
        </div>
        <div>
          <div style={{ fontSize: 9, color: C.muted, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Panier moyen</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: panierMoyen != null ? C.accent : C.muted }}>
            {panierMoyen != null ? euro(panierMoyen) : "â€”"}
          </div>
        </div>
        <div>
          <div style={{ fontSize: 9, color: C.muted, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Pipe value</div>
          <div style={{ fontSize: 16, fontWeight: 800, color: pipeValue > 0 ? C.purple : C.muted }}>
            {pipeValue > 0 ? euro(pipeValue) : "â€”"}
          </div>
        </div>
      </div>
      {/* Bottom stats row */}
      <div style={{ display: "flex", gap: 14, marginTop: 8, paddingTop: 6, borderTop: "1px solid " + C.border, flexWrap: "wrap" }}>
        <div style={{ fontSize: 10, color: C.dim }}>Show-up: <span style={{ fontWeight: 700, color: showUp != null ? (showUp >= 70 ? C.green : C.yellow) : C.muted }}>{showUp != null ? showUp.toFixed(0) + "%" : "â€”"}</span></div>
        <div style={{ fontSize: 10, color: C.dim }}>R1â†’R2: <span style={{ fontWeight: 700, color: ratioR1R2 != null ? (ratioR1R2 >= 30 ? C.green : C.yellow) : C.muted }}>{ratioR1R2 != null ? ratioR1R2.toFixed(0) + "%" : "â€”"}</span></div>
      </div>
    </div>
  );
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// MAIN DASHBOARD
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function Dashboard() {
  const [data, setData] = useState(() => {
    const saved = loadLS();
    if (saved && saved.closing && saved.setting && saved.setting.bySetter) {
      // Migrate: ensure all closers/setters exist
      const base = initialData();
      CLOSERS.forEach(c => { if (!saved.closing[c.id]) saved.closing[c.id] = base.closing[c.id]; });
      SETTERS.forEach(s => { if (!saved.setting.bySetter[s.id]) saved.setting.bySetter[s.id] = base.setting.bySetter[s.id]; });
      if (!saved.setting.bySource) saved.setting.bySource = base.setting.bySource;
      return saved;
    }
    return initialData();
  });
  const [tab, setTab] = useState("cockpit");
  const [closerView, setCloserView] = useState("cards");
  const [settingView, setSettingView] = useState("setter"); // setter or source
  const [viewMode, setViewMode] = useState("month"); // "month", "week", or "day"
  const [selectedDay, setSelectedDay] = useState("2026-02-12"); // today
  const [selectedWeek, setSelectedWeek] = useState(7); // ISO week number (Feb 9-15 = week 7)
  const [planningDay, setPlanningDay] = useState("2026-02-13"); // planning tab day

  // â”€â”€ HubSpot live connection state â”€â”€
  const [hubspotStatus, setHubspotStatus] = useState("disconnected"); // "connected", "loading", "error", "disconnected"
  const [lastHubspotUpdate, setLastHubspotUpdate] = useState(null);
  const [nextRefreshIn, setNextRefreshIn] = useState(null);

  // â”€â”€ Fetch HubSpot data and update state â”€â”€
  const fetchHubSpot = useCallback(async () => {
    setHubspotStatus("loading");
    try {
      const now = new Date();
      const curYear = now.getFullYear();
      const curMonth = now.getMonth() + 1;

      const [closingData, settingData, meetingsData, setterMetrics] = await Promise.all([
        fetchAPI("/api/closing-daily"),
        fetchAPI("/api/setting-daily"),
        fetchAPI(`/api/meetings?year=${curYear}&month=${curMonth}`).catch(e => { console.warn("[HubSpot] meetings:", e); return null; }),
        fetchAPI(`/api/setter-metrics?year=${curYear}`).catch(e => { console.warn("[HubSpot] setter-metrics:", e); return null; }),
      ]);

      // â•â• Step 1: Update global mutable data FIRST (before React re-renders) â•â•
      if (closingData) {
        // â”€â”€ Update DAILY_CLOSING from dailyBreakdown â”€â”€
        if (closingData.dailyBreakdown && Object.keys(closingData.dailyBreakdown).length > 0) {
          Object.keys(DAILY_CLOSING).forEach(k => delete DAILY_CLOSING[k]);
          Object.assign(DAILY_CLOSING, closingData.dailyBreakdown);
          DAILY_DATES.length = 0;
          DAILY_DATES.push(...Object.keys(DAILY_CLOSING).sort());
          console.log("[HubSpot] DAILY_CLOSING updated:", DAILY_DATES.length, "jours");
        }

        // â”€â”€ Update CLOSING_BY_SOURCE from sourceByStage â”€â”€
        const sourceMapped = mapSourceClosing(closingData);
        if (sourceMapped) {
          Object.keys(CLOSING_BY_SOURCE).forEach(k => delete CLOSING_BY_SOURCE[k]);
          Object.assign(CLOSING_BY_SOURCE, sourceMapped);
          // Ensure all expected sources have entries (prevent undefined access)
          const emptySource = { totalDeals: 0, r1NoShow: 0, r1Effectues: 0, r2Bookes: 0, r2NoShow: 0, fuCourt: 0, fuLong: 0, dealsSigne: 0, caSigne: 0, dealsPerdu: 0 };
          CLOSING_SOURCES.forEach(s => {
            if (!CLOSING_BY_SOURCE[s]) CLOSING_BY_SOURCE[s] = { ...emptySource };
          });
          console.log("[HubSpot] CLOSING_BY_SOURCE updated:", Object.keys(CLOSING_BY_SOURCE));
        }
      }

      // â”€â”€ Update MEETINGS_DATA from /api/meetings (only if data exists) â”€â”€
      if (meetingsData && meetingsData.byDate && Object.keys(meetingsData.byDate).length > 0) {
        Object.keys(MEETINGS_DATA).forEach(k => delete MEETINGS_DATA[k]);
        Object.assign(MEETINGS_DATA, meetingsData.byDate);
        console.log("[HubSpot] MEETINGS_DATA updated:", Object.keys(MEETINGS_DATA).length, "jours");
      }

      // â•â• Step 2: Trigger React state updates (batched in React 18) â•â•
      setData(prev => {
        let next = { ...prev };

        // Closing data
        if (closingData) {
          next.closing = mapClosingToState(closingData, prev.closing);
        }

        // Setting data (leads)
        if (settingData) {
          const hasOwners = settingData.owners && Object.keys(settingData.owners).length > 0;
          if (hasOwners) {
            next.setting = {
              ...next.setting,
              bySetter: mapSettingToState(settingData, prev.setting.bySetter),
            };
          }
          const snap = settingData.snapshot || {};
          console.log("[HubSpot] Setting snapshot:", snap.totalLeads, "leads,",
            (snap.byStage?.["1292501786"]?.count || 0), "qualifiÃ©s");
        }

        // Setter metrics (calls + reaction times)
        if (setterMetrics) {
          next.setting = {
            ...next.setting,
            bySetter: mapSetterMetrics(setterMetrics, next.setting.bySetter),
          };
          console.log("[HubSpot] Setter metrics updated:", Object.keys(setterMetrics));
        }

        return next;
      });

      setHubspotStatus("connected");
      setLastHubspotUpdate(new Date());
      console.log("[HubSpot] DonnÃ©es mises Ã  jour:", new Date().toLocaleTimeString("fr-FR"));
    } catch (err) {
      console.error("[HubSpot] Erreur sync:", err);
      setHubspotStatus("error");
    }
  }, []);

  // â”€â”€ Auto-refresh every hour â”€â”€
  useEffect(() => {
    // Initial fetch on mount
    fetchHubSpot();

    // Refresh every hour
    const interval = setInterval(fetchHubSpot, REFRESH_INTERVAL_MS);

    // Countdown timer (updates every minute)
    const countdown = setInterval(() => {
      setNextRefreshIn(prev => {
        if (!lastHubspotUpdate) return null;
        const elapsed = Date.now() - lastHubspotUpdate.getTime();
        const remaining = Math.max(0, REFRESH_INTERVAL_MS - elapsed);
        return Math.ceil(remaining / 60000); // minutes restantes
      });
    }, 60000);

    return () => {
      clearInterval(interval);
      clearInterval(countdown);
    };
  }, [fetchHubSpot, lastHubspotUpdate]);

  useEffect(() => { save(data); }, [data]);

  // â”€â”€ Update functions â”€â”€
  const updateClosing = useCallback((closerId, key, monthIdx, value) => {
    setData(prev => {
      const next = JSON.parse(JSON.stringify(prev));
      if (!next.closing[closerId]) return prev;
      next.closing[closerId][key][monthIdx] = value;
      return next;
    });
  }, []);

  const updateSetter = useCallback((setterId, key, monthIdx, value) => {
    setData(prev => {
      const next = JSON.parse(JSON.stringify(prev));
      if (!next.setting.bySetter[setterId]) return prev;
      next.setting.bySetter[setterId][key][monthIdx] = value;
      return next;
    });
  }, []);

  const updateSettingSource = useCallback((source, key, monthIdx, value) => {
    setData(prev => {
      const next = JSON.parse(JSON.stringify(prev));
      next.setting.bySource[source][key][monthIdx] = value;
      return next;
    });
  }, []);

  // â”€â”€ Setting KPIs (all setters) â”€â”€
  const settingStats = useMemo(() => {
    const mi = CURRENT_MONTH;
    let totalLeads = 0, totalQualifies = 0, totalRdv = 0, totalAppels = 0;
    SETTERS.forEach(s => {
      const d = data.setting.bySetter[s.id] || {};
      totalLeads += (d.leadsRecus || [])[mi] || 0;
      totalQualifies += (d.leadsQualifies || [])[mi] || 0;
      totalRdv += (d.rdvBookes || [])[mi] || 0;
      totalAppels += (d.appelsTotaux || [])[mi] || 0;
    });
    const tauxQualif = totalLeads > 0 ? (totalQualifies / totalLeads * 100) : null;
    const tauxRdv = totalLeads > 0 ? (totalRdv / totalLeads * 100) : null;
    // Average reaction time across setters (weighted by leads)
    let totalReactionWeighted = 0, totalReactionLeads = 0;
    SETTERS.forEach(s => {
      const d = data.setting.bySetter[s.id] || {};
      const rt = (d.tempsReaction || [])[mi];
      const ld = (d.leadsRecus || [])[mi] || 0;
      if (rt != null && ld > 0) { totalReactionWeighted += rt * ld; totalReactionLeads += ld; }
    });
    const avgReaction = totalReactionLeads > 0 ? Math.round(totalReactionWeighted / totalReactionLeads) : null;
    return { totalLeads, totalQualifies, totalRdv, totalAppels, tauxQualif, tauxRdv, avgReaction };
  }, [data.setting.bySetter]);

  // â”€â”€ Closing KPIs (all closers) â”€â”€
  const closingStats = useMemo(() => {
    const mi = CURRENT_MONTH;
    let totalR1 = 0, totalNoShow = 0, totalEff = 0, totalDeals = 0, totalCA = 0, totalPerdu = 0, totalR2 = 0;
    CLOSERS.forEach(c => {
      const d = data.closing[c.id] || {};
      totalR1 += (d.r1Bookes || [])[mi] || 0;
      totalNoShow += (d.r1NoShow || [])[mi] || 0;
      totalEff += (d.r1Effectues || [])[mi] || 0;
      totalR2 += (d.r2Bookes || [])[mi] || 0;
      totalDeals += (d.dealsSigne || [])[mi] || 0;
      totalCA += (d.caSign || [])[mi] || 0;
      totalPerdu += (d.dealsPerdu || [])[mi] || 0;
    });
    const showUp = (totalEff + totalNoShow) > 0 ? (totalEff / (totalEff + totalNoShow) * 100) : null;
    const tauxClosing = totalEff > 0 ? (totalDeals / totalEff * 100) : null;
    const panierMoyen = totalDeals > 0 ? Math.round(totalCA / totalDeals) : null;
    // Pipe value pondÃ©rÃ©e globale
    const pipeDealsEnCours = totalR1 - totalDeals - totalPerdu;
    const pipeValue = pipeDealsEnCours > 0 ? Math.round(
      (totalEff * 0.05 + totalR2 * 0.25 + Math.max(0, totalR1 - totalEff - totalNoShow - totalR2 - totalDeals - totalPerdu) * 0.15) * (panierMoyen || OBJECTIVES.panierMoyen)
    ) : 0;
    return { totalR1, totalEff, totalDeals, totalCA, showUp, tauxClosing, totalPerdu, totalR2, panierMoyen, pipeValue };
  }, [data.closing]);

  // â”€â”€ Daily closing stats â”€â”€
  const dailyClosingStats = useMemo(() => {
    const dayData = DAILY_CLOSING[selectedDay];
    if (!dayData) return { totalR1: 0, totalEff: 0, totalDeals: 0, totalCA: 0, showUp: null, tauxClosing: null, totalPerdu: 0, closerData: {} };
    const t = dayData._total || {};
    const totalR1 = t.newDeals || 0;
    const noshow = t.noshow || 0;
    const totalEff = totalR1 - noshow;
    const totalDeals = t.won || 0;
    const totalCA = t.ca || 0;
    const totalPerdu = t.lost || 0;
    const showUp = totalR1 > 0 ? (totalEff / totalR1 * 100) : null;
    const tauxClosing = totalEff > 0 ? (totalDeals / totalEff * 100) : null;
    // Per-closer
    const closerData = {};
    CLOSERS.forEach(c => {
      const cd = dayData[c.id] || {};
      closerData[c.id] = {
        newDeals: cd.newDeals || 0, r1: cd.r1 || 0, noshow: cd.noshow || 0,
        r2: cd.r2 || 0, won: cd.won || 0, lost: cd.lost || 0,
        ca: cd.ca || 0, fu: cd.fu || 0,
      };
    });
    return { totalR1, totalEff, totalDeals, totalCA, showUp, tauxClosing, totalPerdu, closerData };
  }, [selectedDay]);

  // â”€â”€ Day navigation â”€â”€
  const navigateDay = useCallback((dir) => {
    setSelectedDay(prev => {
      const d = new Date(prev);
      d.setDate(d.getDate() + dir);
      const iso = d.toISOString().slice(0, 10);
      if (iso < "2026-02-01" || iso > "2026-02-28") return prev;
      return iso;
    });
  }, []);

  const dayLabel = useMemo(() => {
    const d = new Date(selectedDay);
    const days = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
    return days[d.getDay()] + " " + d.getDate() + " FÃ©v";
  }, [selectedDay]);

  // â”€â”€ Planning day navigation â”€â”€
  const navigatePlanningDay = useCallback((dir) => {
    setPlanningDay(prev => {
      const d = new Date(prev);
      d.setDate(d.getDate() + dir);
      const iso = d.toISOString().slice(0, 10);
      if (iso < "2026-02-01" || iso > "2026-02-28") return prev;
      return iso;
    });
  }, []);

  const planningDayLabel = useMemo(() => {
    const d = new Date(planningDay);
    const days = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
    return days[d.getDay()] + " " + d.getDate() + " FÃ©v";
  }, [planningDay]);

  // â”€â”€ Planning stats â”€â”€
  const planningStats = useMemo(() => {
    const meetings = MEETINGS_DATA[planningDay] || [];
    const total = meetings.length;
    const completed = meetings.filter(m => m.outcome === "COMPLETED").length;
    const noShow = meetings.filter(m => m.outcome === "NO_SHOW").length;
    const scheduled = meetings.filter(m => m.outcome === "SCHEDULED").length;
    const cancelled = meetings.filter(m => m.outcome === "CANCELLED").length;
    const rescheduled = meetings.filter(m => m.outcome === "RESCHEDULED").length;
    const showUpRate = total > 0 ? ((completed / (completed + noShow)) * 100) : 0;

    // Group by closer
    const byCloser = {};
    meetings.forEach(m => {
      if (!byCloser[m.owner]) byCloser[m.owner] = [];
      byCloser[m.owner].push(m);
    });

    // Sort each closer's meetings by start time
    Object.values(byCloser).forEach(arr => arr.sort((a, b) => a.start.localeCompare(b.start)));

    return { meetings, total, completed, noShow, scheduled, cancelled, rescheduled, showUpRate, byCloser };
  }, [planningDay]);

  // â”€â”€ Week helpers â”€â”€
  const getWeekDates = useCallback((weekNum) => {
    // ISO week: week 6 = Feb 2-8, week 7 = Feb 9-15, week 8 = Feb 16-22, week 9 = Feb 23-28
    const jan1 = new Date(2026, 0, 1);
    const dayOfWeek = jan1.getDay() || 7; // Mon=1
    const firstMonday = new Date(2026, 0, 1 + (1 - dayOfWeek + 7) % 7);
    const weekStart = new Date(firstMonday);
    weekStart.setDate(firstMonday.getDate() + (weekNum - 1) * 7);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    const dates = [];
    for (let d = new Date(weekStart); d <= weekEnd; d.setDate(d.getDate() + 1)) {
      const iso = d.toISOString().slice(0, 10);
      if (iso >= "2026-02-01" && iso <= "2026-02-28") dates.push(iso);
    }
    return dates;
  }, []);

  const weekDates = useMemo(() => getWeekDates(selectedWeek), [selectedWeek, getWeekDates]);

  const weekLabel = useMemo(() => {
    if (weekDates.length === 0) return "Semaine " + selectedWeek;
    const first = new Date(weekDates[0]);
    const last = new Date(weekDates[weekDates.length - 1]);
    return first.getDate() + " â€” " + last.getDate() + " FÃ©v";
  }, [weekDates, selectedWeek]);

  const navigateWeek = useCallback((dir) => {
    setSelectedWeek(prev => {
      const next = prev + dir;
      if (next < 5 || next > 9) return prev; // Feb 2026 weeks range
      return next;
    });
  }, []);

  // â”€â”€ Weekly closing stats â”€â”€
  const weeklyClosingStats = useMemo(() => {
    let totalR1 = 0, totalEff = 0, totalDeals = 0, totalCA = 0, totalPerdu = 0, totalNoShow = 0;
    const closerData = {};
    CLOSERS.forEach(c => { closerData[c.id] = { newDeals: 0, r1: 0, noshow: 0, r2: 0, won: 0, lost: 0, ca: 0, fu: 0 }; });
    weekDates.forEach(date => {
      const dayData = DAILY_CLOSING[date];
      if (!dayData) return;
      const t = dayData._total || {};
      totalR1 += t.newDeals || 0;
      totalNoShow += t.noshow || 0;
      totalDeals += t.won || 0;
      totalCA += t.ca || 0;
      totalPerdu += t.lost || 0;
      CLOSERS.forEach(c => {
        const cd = dayData[c.id] || {};
        closerData[c.id].newDeals += cd.newDeals || 0;
        closerData[c.id].r1 += cd.r1 || 0;
        closerData[c.id].noshow += cd.noshow || 0;
        closerData[c.id].r2 += cd.r2 || 0;
        closerData[c.id].won += cd.won || 0;
        closerData[c.id].lost += cd.lost || 0;
        closerData[c.id].ca += cd.ca || 0;
        closerData[c.id].fu += cd.fu || 0;
      });
    });
    totalEff = totalR1 - totalNoShow;
    const showUp = totalR1 > 0 ? (totalEff / totalR1 * 100) : null;
    const tauxClosing = totalEff > 0 ? (totalDeals / totalEff * 100) : null;
    return { totalR1, totalEff, totalDeals, totalCA, showUp, tauxClosing, totalPerdu, closerData };
  }, [weekDates]);

  // â”€â”€ Charts data â”€â”€
  const closerChartData = useMemo(() => {
    const mi = CURRENT_MONTH;
    return CLOSERS.map(c => {
      const d = data.closing[c.id] || {};
      return { name: c.name, deals: (d.dealsSigne || [])[mi] || 0, r1: (d.r1Bookes || [])[mi] || 0, ca: (d.caSign || [])[mi] || 0, color: c.color };
    }).sort((a, b) => b.deals - a.deals);
  }, [data.closing]);

  const monthlyCloserData = useMemo(() => {
    return MONTHS.map((m, i) => {
      const row = { name: m };
      CLOSERS.forEach(c => { row[c.name] = (data.closing[c.id]?.dealsSigne || [])[i] || 0; });
      return row;
    });
  }, [data.closing]);

  const setterChartData = useMemo(() => {
    const mi = CURRENT_MONTH;
    return SETTERS.map(s => {
      const d = data.setting.bySetter[s.id] || {};
      return {
        name: s.name,
        leads: (d.leadsRecus || [])[mi] || 0,
        qualifies: (d.leadsQualifies || [])[mi] || 0,
        rdv: (d.rdvBookes || [])[mi] || 0,
        color: s.color,
      };
    });
  }, [data.setting.bySetter]);

  const monthlySetterData = useMemo(() => {
    return MONTHS.map((m, i) => {
      const row = { name: m };
      SETTERS.forEach(s => { row[s.name] = (data.setting.bySetter[s.id]?.rdvBookes || [])[i] || 0; });
      return row;
    });
  }, [data.setting.bySetter]);

  // Row definitions
  const setterRows = [
    { key: "leadsRecus", label: "Leads reÃ§us" },
    { key: "leadsContactes", label: "Leads contactÃ©s" },
    { key: "leadsQualifies", label: "Leads qualifiÃ©s" },
    { key: "rdvBookes", label: "RDV bookÃ©s" },
    { key: "appelsTotaux", label: "Appels totaux" },
    { key: "appelsDecroches", label: "Appels dÃ©crochÃ©s" },
    { key: "tempsReaction", label: "Temps rÃ©action (min)" },
    { key: "disqualifies", label: "DisqualifiÃ©s" },
    { key: "tauxQualif", label: "Taux qualification", computed: true,
      computeFn: (d, i) => (d.leadsRecus || [])[i] > 0 ? (((d.leadsQualifies || [])[i] || 0) / d.leadsRecus[i] * 100).toFixed(1) + "%" : "â€”" },
    { key: "tauxRdv", label: "Taux prise RDV", computed: true,
      computeFn: (d, i) => (d.leadsRecus || [])[i] > 0 ? (((d.rdvBookes || [])[i] || 0) / d.leadsRecus[i] * 100).toFixed(1) + "%" : "â€”" },
    { key: "connexionRate", label: "Taux connexion", computed: true,
      computeFn: (d, i) => (d.appelsTotaux || [])[i] > 0 ? (((d.appelsDecroches || [])[i] || 0) / d.appelsTotaux[i] * 100).toFixed(1) + "%" : "â€”" },
  ];

  const closerRows = [
    { key: "r1Bookes", label: "Total deals (pipeline)" },
    { key: "r1NoShow", label: "R1 No Show" },
    { key: "r1Effectues", label: "R1 effectuÃ©s" },
    { key: "r2Bookes", label: "R2 bookÃ©s" },
    { key: "dealsSigne", label: "Deals signÃ©s" },
    { key: "dealsPerdu", label: "Deals perdus" },
    { key: "caSign", label: "CA signÃ© (â‚¬)", format: "euro" },
    { key: "tauxShowUp", label: "Taux show-up", computed: true,
      computeFn: (d, i) => { const eff = (d.r1Effectues || [])[i] || 0; const ns = (d.r1NoShow || [])[i] || 0; return (eff + ns) > 0 ? (eff / (eff + ns) * 100).toFixed(1) + "%" : "â€”"; } },
    { key: "tauxClosing", label: "Taux closing", computed: true,
      computeFn: (d, i) => { const eff = (d.r1Effectues || [])[i] || 0; return eff > 0 ? (((d.dealsSigne || [])[i] || 0) / eff * 100).toFixed(1) + "%" : "â€”"; } },
  ];

  const settingSourceRows = [
    { key: "leads", label: "Leads reÃ§us" },
    { key: "rdvBookes", label: "RDV bookÃ©s" },
    { key: "r1Bookes", label: "R1 bookÃ©s" },
    { key: "tauxPriseRdv", label: "Taux prise RDV", computed: true,
      computeFn: (d, i) => (d.leads || [])[i] > 0 ? (((d.rdvBookes || [])[i] || 0) / d.leads[i] * 100).toFixed(1) + "%" : "â€”" },
    { key: "tempsReaction", label: "Temps rÃ©action (min)" },
  ];

  const tabs = [
    { id: "cockpit", label: "ðŸŽ¯ Cockpit" },
    { id: "closing", label: "ðŸ† Closing" },
    { id: "sources", label: "ðŸ“Š Sources" },
    { id: "setting", label: "ðŸ“ž Setting" },
    { id: "planning", label: "ðŸ“… Planning" },
  ];

  return (
    <div style={{ minHeight: "100vh", background: C.bg }}>

      {/* Header */}
      <header style={{ background: "rgba(17,24,39,0.95)", backdropFilter: "blur(20px)", borderBottom: "1px solid " + C.border, padding: "14px 28px", position: "sticky", top: 0, zIndex: 100, boxShadow: "0 4px 20px rgba(0,0,0,0.3)" }}>
        <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 }}>
          <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
            <div style={{ width: 36, height: 36, borderRadius: 10, background: C.gradientAccent, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, fontWeight: 800, color: "#fff" }}>S</div>
            <div>
              <span style={{ fontSize: 18, fontWeight: 800, color: C.text }}>studeria</span>
              <span style={{ fontSize: 12, color: C.muted, marginLeft: 10 }}>Sales B2C â€” 2026</span>
            </div>
          </div>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            {/* HubSpot Status Badge â€” dynamique */}
            {hubspotStatus === "connected" && (
              <div style={{ padding: "5px 12px", borderRadius: 8, background: "rgba(52,211,153,0.1)", color: C.green, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 5, border: "1px solid rgba(52,211,153,0.3)" }}>
                <span style={{ width: 7, height: 7, borderRadius: "50%", background: C.green, display: "inline-block", animation: "pulse 2s infinite" }}></span>
                HubSpot LIVE
              </div>
            )}
            {hubspotStatus === "loading" && (
              <div style={{ padding: "5px 12px", borderRadius: 8, background: "rgba(251,191,36,0.1)", color: C.yellow, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 5, border: "1px solid rgba(251,191,36,0.3)" }}>
                <span style={{ fontSize: 12 }}>â³</span>
                Synchronisation...
              </div>
            )}
            {hubspotStatus === "error" && (
              <div style={{ padding: "5px 12px", borderRadius: 8, background: "rgba(248,113,113,0.1)", color: C.red, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 5, border: "1px solid rgba(248,113,113,0.3)" }}>
                <span style={{ width: 7, height: 7, borderRadius: "50%", background: C.red, display: "inline-block" }}></span>
                Erreur HubSpot
              </div>
            )}
            {hubspotStatus === "disconnected" && (
              <div style={{ padding: "5px 12px", borderRadius: 8, background: "rgba(100,116,139,0.1)", color: C.muted, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 5, border: "1px solid rgba(100,116,139,0.3)" }}>
                <span style={{ width: 7, height: 7, borderRadius: "50%", background: C.muted, display: "inline-block" }}></span>
                Hors-ligne
              </div>
            )}

            {/* DerniÃ¨re MAJ */}
            {lastHubspotUpdate && (
              <div style={{ fontSize: 10, color: C.muted, display: "flex", flexDirection: "column", alignItems: "flex-end", lineHeight: 1.3 }}>
                <span>MAJ: {lastHubspotUpdate.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })}</span>
                {nextRefreshIn != null && <span>Prochain: {nextRefreshIn} min</span>}
              </div>
            )}

            {/* Bouton refresh manuel */}
            <button onClick={fetchHubSpot} disabled={hubspotStatus === "loading"}
              title="RafraÃ®chir maintenant"
              style={{ padding: "5px 10px", borderRadius: 8, border: "1px solid " + C.border, background: hubspotStatus === "loading" ? "rgba(255,255,255,0.02)" : "rgba(99,102,241,0.1)", color: hubspotStatus === "loading" ? C.muted : C.accent, fontSize: 14, cursor: hubspotStatus === "loading" ? "wait" : "pointer", fontFamily: "inherit", transition: "all 0.2s" }}>
              ðŸ”„
            </button>

            <button onClick={() => { if (confirm("RÃ©initialiser toutes les donnÃ©es ?")) { setData(initialData()); localStorage.removeItem(LS); } }}
              style={{ padding: "5px 14px", borderRadius: 8, border: "1px solid rgba(248,113,113,0.3)", background: "rgba(248,113,113,0.1)", color: C.red, fontSize: 11, cursor: "pointer", fontFamily: "inherit", fontWeight: 500 }}>
              Reset
            </button>
          </div>
        </div>

        {/* Tabs + View Mode */}
        <div style={{ display: "flex", gap: 4, alignItems: "center", justifyContent: "space-between" }}>
          <div style={{ display: "flex", gap: 4 }}>
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)}
                className={`tab-btn ${tab === t.id ? "active" : ""}`}>
                {t.label}
              </button>
            ))}
          </div>
          <div style={{ display: "flex", gap: 4, alignItems: "center" }}>
            {tab === "closing" && <>
            <button onClick={() => setViewMode("month")} className={`view-btn ${viewMode === "month" ? "active" : ""}`}>ðŸ“… Mois</button>
            <button onClick={() => setViewMode("week")} className={`view-btn ${viewMode === "week" ? "active" : ""}`}>ðŸ“Š Semaine</button>
            <button onClick={() => setViewMode("day")} className={`view-btn ${viewMode === "day" ? "active" : ""}`}>ðŸ“† Jour</button>
            {viewMode === "day" && (
              <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 8 }}>
                <button onClick={() => navigateDay(-1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â—€</button>
                <span style={{ fontSize: 14, fontWeight: 700, color: C.text, minWidth: 100, textAlign: "center" }}>{dayLabel}</span>
                <button onClick={() => navigateDay(1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â–¶</button>
              </div>
            )}
            {viewMode === "week" && (
              <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 8 }}>
                <button onClick={() => navigateWeek(-1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â—€</button>
                <span style={{ fontSize: 14, fontWeight: 700, color: C.text, minWidth: 120, textAlign: "center" }}>S{selectedWeek} Â· {weekLabel}</span>
                <button onClick={() => navigateWeek(1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â–¶</button>
              </div>
            )}
            </>}
            {tab === "planning" && (
              <div style={{ display: "flex", alignItems: "center", gap: 6, marginLeft: 8 }}>
                <button onClick={() => navigatePlanningDay(-1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â—€</button>
                <span style={{ fontSize: 14, fontWeight: 700, color: C.text, minWidth: 100, textAlign: "center" }}>{planningDayLabel}</span>
                <button onClick={() => navigatePlanningDay(1)} style={{ background: "rgba(255,255,255,0.06)", border: "1px solid " + C.border, borderRadius: 8, color: C.text, padding: "5px 12px", cursor: "pointer", fontSize: 14, fontFamily: "inherit" }}>â–¶</button>
              </div>
            )}
          </div>
        </div>
      </header>

      <main style={{ padding: "24px 28px", maxWidth: 1500, margin: "0 auto" }}>

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COCKPIT TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "cockpit" && (() => {
          // Actual data from closing stats
          const actual = closingStats;
          const caActuel = actual.totalCA;
          const caObjectif = PROJ_CA_MENSUEL;
          const progressCA = caObjectif > 0 ? (caActuel / caObjectif * 100) : 0;
          const joursMois = 28; // Feb 2026
          const joursEcoules = 13; // 13 fÃ©v
          const joursRestants = joursMois - joursEcoules;
          const progressTemps = (joursEcoules / joursMois * 100);
          const rythmeActuel = joursEcoules > 0 ? (caActuel / joursEcoules) : 0;
          const projectionFinMois = Math.round(rythmeActuel * joursMois);
          const caRestantNecessaire = Math.max(0, caObjectif - caActuel);
          const caParJourRestant = joursRestants > 0 ? Math.round(caRestantNecessaire / joursRestants) : 0;

          // Pipe value calculation (weighted by stage)
          const pipeR1 = actual.totalR1 - actual.totalDeals - actual.totalPerdu - actual.totalEff;
          const pipeR1Value = Math.max(0, pipeR1) * OBJECTIVES.panierMoyen * (PIPE_WEIGHTS["1290057281"] || 0.05);
          const pipeR2Value = actual.totalR2 * OBJECTIVES.panierMoyen * (PIPE_WEIGHTS["1290057284"] || 0.25);
          // FU from source data
          const totalFU = Object.values(CLOSING_BY_SOURCE).reduce((s, src) => s + src.fuCourt + src.fuLong, 0);
          const pipeFUValue = totalFU * OBJECTIVES.panierMoyen * 0.12;
          const totalPipeValue = Math.round(caActuel + pipeR1Value + pipeR2Value + pipeFUValue);

          // Funnel actual
          const totalLeadsSetting = settingStats.totalLeads;
          const totalRdvSetting = settingStats.totalRdv;
          const totalR1Closing = actual.totalR1;
          const totalR1Eff = actual.totalEff;
          const totalDeals = actual.totalDeals;

          // Alerts
          const alerts = [];
          if (actual.showUp != null && actual.showUp < OBJECTIVES.tauxShowUp)
            alerts.push({ type: "warning", text: `Show-up Ã  ${actual.showUp.toFixed(0)}% (objectif: ${OBJECTIVES.tauxShowUp}%)`, icon: "âš ï¸" });
          if (actual.tauxClosing != null && actual.tauxClosing < OBJECTIVES.tauxClosing)
            alerts.push({ type: "danger", text: `Taux closing Ã  ${actual.tauxClosing.toFixed(1)}% (objectif: ${OBJECTIVES.tauxClosing}%)`, icon: "ðŸ”´" });
          if (progressCA < progressTemps * 0.5)
            alerts.push({ type: "danger", text: `CA trÃ¨s en retard: ${progressCA.toFixed(1)}% rÃ©alisÃ© vs ${progressTemps.toFixed(0)}% du mois Ã©coulÃ©`, icon: "ðŸš¨" });
          // Per-closer alerts
          CLOSERS.forEach(c => {
            const d = data.closing[c.id] || {};
            const eff = (d.r1Effectues || [])[CURRENT_MONTH] || 0;
            const deals = (d.dealsSigne || [])[CURRENT_MONTH] || 0;
            const r1 = (d.r1Bookes || [])[CURRENT_MONTH] || 0;
            const noshow = (d.r1NoShow || [])[CURRENT_MONTH] || 0;
            if (r1 >= 10 && deals === 0)
              alerts.push({ type: "warning", text: `${c.name}: ${r1} deals, 0 signÃ©`, icon: "ðŸ‘¤" });
            if ((eff + noshow) > 3) {
              const su = eff / (eff + noshow) * 100;
              if (su < 50)
                alerts.push({ type: "warning", text: `${c.name}: show-up trÃ¨s bas (${su.toFixed(0)}%)`, icon: "ðŸ“‰" });
            }
          });

          // Avg deal value
          const avgDeal = actual.totalDeals > 0 ? Math.round(actual.totalCA / actual.totalDeals) : 0;
          const dealsNeeded = avgDeal > 0 ? Math.ceil(caRestantNecessaire / avgDeal) : "â€”";

          return (
            <>
            {/* Progression CA â€” main gauge */}
            <div style={{ background: C.card, borderRadius: 16, padding: "24px 28px", border: "1px solid " + C.border, boxShadow: C.cardShadow, marginBottom: 20 }}>
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 16 }}>
                <div>
                  <div style={{ fontSize: 11, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.06em" }}>Objectif CA mensuel â€” FÃ©vrier 2026</div>
                  <div style={{ fontSize: 36, fontWeight: 900, color: C.text, lineHeight: 1.2, marginTop: 4 }}>{euro(caActuel)}</div>
                  <div style={{ fontSize: 13, color: C.muted, marginTop: 2 }}>sur {euro(caObjectif)} objectif</div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontSize: 42, fontWeight: 900, color: progressCA >= progressTemps ? C.green : progressCA >= progressTemps * 0.5 ? C.yellow : C.red }}>{progressCA.toFixed(1)}%</div>
                  <div style={{ fontSize: 11, color: C.muted }}>{progressTemps.toFixed(0)}% du mois Ã©coulÃ©</div>
                </div>
              </div>
              {/* Progress bar */}
              <div style={{ position: "relative", height: 28, borderRadius: 14, background: "rgba(255,255,255,0.06)", overflow: "hidden" }}>
                <div style={{ position: "absolute", left: 0, top: 0, bottom: 0, width: Math.min(progressCA, 100) + "%", borderRadius: 14, background: progressCA >= progressTemps ? "linear-gradient(90deg, #059669, #34d399)" : progressCA >= progressTemps * 0.5 ? "linear-gradient(90deg, #d97706, #fbbf24)" : "linear-gradient(90deg, #dc2626, #f87171)", transition: "width 0.5s ease" }}></div>
                {/* Time marker */}
                <div style={{ position: "absolute", left: progressTemps + "%", top: 0, bottom: 0, width: 2, background: "rgba(255,255,255,0.4)", zIndex: 2 }}></div>
                <div style={{ position: "absolute", left: progressTemps + "%", top: -18, transform: "translateX(-50%)", fontSize: 9, color: C.dim, fontWeight: 600, whiteSpace: "nowrap" }}>J{joursEcoules}/{joursMois}</div>
              </div>
              {/* Sub-metrics */}
              <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 16, marginTop: 18 }}>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600 }}>Rythme / jour</div>
                  <div style={{ fontSize: 20, fontWeight: 800, color: C.text }}>{euro(Math.round(rythmeActuel))}</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600 }}>Projection fin mois</div>
                  <div style={{ fontSize: 20, fontWeight: 800, color: projectionFinMois >= caObjectif ? C.green : C.red }}>{euro(projectionFinMois)}</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600 }}>CA restant / jour</div>
                  <div style={{ fontSize: 20, fontWeight: 800, color: C.accent }}>{euro(caParJourRestant)}</div>
                </div>
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600 }}>Deals Ã  signer</div>
                  <div style={{ fontSize: 20, fontWeight: 800, color: C.accent }}>{dealsNeeded}</div>
                </div>
              </div>
            </div>

            {/* KPI row: Actual vs Objectif */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 12, marginBottom: 20 }}>
              <div style={{ background: C.card, borderRadius: 12, padding: "14px 16px", border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Show-up</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: (actual.showUp || 0) >= OBJECTIVES.tauxShowUp ? C.green : C.yellow }}>{actual.showUp != null ? actual.showUp.toFixed(0) + "%" : "â€”"}</div>
                <div style={{ fontSize: 10, color: C.muted }}>Obj: {OBJECTIVES.tauxShowUp}%</div>
              </div>
              <div style={{ background: C.card, borderRadius: 12, padding: "14px 16px", border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Taux closing</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: (actual.tauxClosing || 0) >= OBJECTIVES.tauxClosing ? C.green : C.red }}>{actual.tauxClosing != null ? actual.tauxClosing.toFixed(1) + "%" : "â€”"}</div>
                <div style={{ fontSize: 10, color: C.muted }}>Obj: {OBJECTIVES.tauxClosing}%</div>
              </div>
              <div style={{ background: C.card, borderRadius: 12, padding: "14px 16px", border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Panier moyen</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: avgDeal >= OBJECTIVES.panierMoyen ? C.green : C.yellow }}>{avgDeal > 0 ? euro(avgDeal) : "â€”"}</div>
                <div style={{ fontSize: 10, color: C.muted }}>Obj: {euro(OBJECTIVES.panierMoyen)}</div>
              </div>
              <div style={{ background: C.card, borderRadius: 12, padding: "14px 16px", border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Deals signÃ©s</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: C.green }}>{actual.totalDeals}</div>
                <div style={{ fontSize: 10, color: C.muted }}>Proj: ~{PROJ_DEALS_SIGNES}</div>
              </div>
              <div style={{ background: C.card, borderRadius: 12, padding: "14px 16px", border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Pipe value</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: C.accent }}>{euro(totalPipeValue)}</div>
                <div style={{ fontSize: 10, color: C.muted }}>PondÃ©rÃ© par stage</div>
              </div>
            </div>

            {/* Funnel visuel + Alerts */}
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>

              {/* Funnel */}
              <div style={{ background: C.card, borderRadius: 12, padding: 20, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 16 }}>Funnel de conversion â€” RÃ©el vs Objectif</div>
                {[
                  { label: "Leads (Setting)", actual: totalLeadsSetting, proj: PROJ_TOTAL_OPTINS, color: "#64748b", icon: "ðŸ“¥" },
                  { label: "R1 bookÃ©s (Closing)", actual: totalR1Closing, proj: PROJ_TOTAL_R1, color: C.blue, icon: "ðŸ“…" },
                  { label: "R1 effectuÃ©s", actual: totalR1Eff, proj: PROJ_R1_EFFECTUES, color: C.accent, icon: "âœ…" },
                  { label: "Deals signÃ©s", actual: totalDeals, proj: PROJ_DEALS_SIGNES, color: C.green, icon: "ðŸ†" },
                  { label: "CA", actual: caActuel, proj: caObjectif, color: C.accent, icon: "ðŸ’°", isCurrency: true },
                ].map((step, i) => {
                  const pct = step.proj > 0 ? (step.actual / step.proj * 100) : 0;
                  return (
                    <div key={i} style={{ marginBottom: i < 4 ? 10 : 0 }}>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                        <span style={{ fontSize: 12, fontWeight: 600, color: C.text }}>{step.icon} {step.label}</span>
                        <span style={{ fontSize: 12, fontWeight: 700, color: step.color }}>
                          {step.isCurrency ? euro(step.actual) : num(step.actual)}
                          <span style={{ color: C.muted, fontWeight: 400 }}> / {step.isCurrency ? euro(step.proj) : num(step.proj)}</span>
                        </span>
                      </div>
                      <div style={{ height: 10, borderRadius: 5, background: "rgba(255,255,255,0.06)", overflow: "hidden" }}>
                        <div style={{ height: "100%", width: Math.min(pct, 100) + "%", borderRadius: 5, background: pct >= 80 ? step.color : pct >= 40 ? C.yellow : C.red, transition: "width 0.4s ease" }}></div>
                      </div>
                      <div style={{ fontSize: 9, color: C.muted, textAlign: "right", marginTop: 1 }}>{pct.toFixed(1)}%</div>
                      {i < 4 && <div style={{ textAlign: "center", fontSize: 11, color: C.muted, margin: "2px 0" }}>â–¼</div>}
                    </div>
                  );
                })}
              </div>

              {/* Alerts + Projections */}
              <div style={{ display: "flex", flexDirection: "column", gap: 16 }}>
                {/* Alerts */}
                <div style={{ background: C.card, borderRadius: 12, padding: 20, border: "1px solid " + C.border, boxShadow: C.cardShadow, flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>Signaux d'attention</div>
                  {alerts.length === 0 ? (
                    <div style={{ padding: 16, textAlign: "center", color: C.green, fontSize: 13, fontWeight: 600 }}>Tous les indicateurs sont dans les clous !</div>
                  ) : (
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {alerts.map((a, i) => (
                        <div key={i} style={{ padding: "8px 12px", borderRadius: 8, background: a.type === "danger" ? "rgba(248,113,113,0.1)" : "rgba(251,191,36,0.1)", borderLeft: `3px solid ${a.type === "danger" ? C.red : C.yellow}`, fontSize: 12, color: C.text }}>
                          <span style={{ marginRight: 6 }}>{a.icon}</span>{a.text}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Projection Marketing */}
                <div style={{ background: C.card, borderRadius: 12, padding: 20, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
                  <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>Projections Marketing â€” FÃ©v</div>
                  <div style={{ overflowX: "auto" }}>
                    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
                      <thead>
                        <tr style={{ background: "rgba(255,255,255,0.03)" }}>
                          <th style={{ padding: "8px 10px", textAlign: "left", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Source</th>
                          <th style={{ padding: "8px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>R1 VSL</th>
                          <th style={{ padding: "8px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Optins</th>
                          <th style={{ padding: "8px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>R1 Setter</th>
                          <th style={{ padding: "8px 8px", textAlign: "right", fontWeight: 600, color: C.accent, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Total R1</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(PROJECTIONS).map(([source, p], i) => {
                          const r1Setter = Math.round(p.optins * OBJECTIVES.tauxSetterRDV / 100);
                          return (
                            <tr key={source} style={{ borderBottom: i < Object.keys(PROJECTIONS).length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none" }}>
                              <td style={{ padding: "8px 10px", fontWeight: 600, color: CLOSING_SOURCE_COLORS[source] || C.text }}>{source}</td>
                              <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 600, color: p.r1Bookes > 0 ? C.text : C.muted }}>{p.r1Bookes || "â€”"}</td>
                              <td style={{ padding: "8px 8px", textAlign: "right" }}>{num(p.optins)}</td>
                              <td style={{ padding: "8px 8px", textAlign: "right", color: C.cyan }}>{r1Setter}</td>
                              <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 700, color: C.accent }}>{num(p.r1Bookes + r1Setter)}</td>
                            </tr>
                          );
                        })}
                        <tr style={{ borderTop: "2px solid " + C.border, background: "rgba(255,255,255,0.03)" }}>
                          <td style={{ padding: "8px 10px", fontWeight: 800 }}>TOTAL</td>
                          <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 800 }}>{num(PROJ_TOTAL_R1_DIRECT)}</td>
                          <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 700 }}>{num(PROJ_TOTAL_OPTINS)}</td>
                          <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 700, color: C.cyan }}>{num(PROJ_R1_VIA_SETTER)}</td>
                          <td style={{ padding: "8px 8px", textAlign: "right", fontWeight: 800, color: C.accent }}>{num(PROJ_TOTAL_R1)}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            {/* Closer leaderboard compact */}
            <div style={{ background: C.card, borderRadius: 12, padding: 20, border: "1px solid " + C.border, boxShadow: C.cardShadow, marginBottom: 20 }}>
              <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 14 }}>Classement closers â€” FÃ©v 2026</div>
              <div style={{ overflowX: "auto" }}>
                <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                  <thead>
                    <tr style={{ background: "rgba(255,255,255,0.03)" }}>
                      <th style={{ padding: "10px 12px", textAlign: "left", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>#</th>
                      <th style={{ padding: "10px 12px", textAlign: "left", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Closer</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Pipeline</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>R1 Eff.</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Show-up</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>SignÃ©s</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Closing</th>
                      <th style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.accent, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>CA</th>
                    </tr>
                  </thead>
                  <tbody>
                    {CLOSERS.map(c => {
                      const d = data.closing[c.id] || {};
                      return {
                        closer: c,
                        r1: (d.r1Bookes || [])[CURRENT_MONTH] || 0,
                        eff: (d.r1Effectues || [])[CURRENT_MONTH] || 0,
                        noshow: (d.r1NoShow || [])[CURRENT_MONTH] || 0,
                        deals: (d.dealsSigne || [])[CURRENT_MONTH] || 0,
                        ca: (d.caSign || [])[CURRENT_MONTH] || 0,
                      };
                    }).sort((a, b) => b.ca - a.ca || b.deals - a.deals).map((row, i) => {
                      const su = (row.eff + row.noshow) > 0 ? (row.eff / (row.eff + row.noshow) * 100) : null;
                      const cl = row.eff > 0 ? (row.deals / row.eff * 100) : null;
                      return (
                        <tr key={row.closer.id} style={{ borderBottom: i < CLOSERS.length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none", background: i < 3 ? "rgba(99,102,241,0.05)" : "transparent" }}>
                          <td style={{ padding: "10px 12px", fontWeight: 700, color: i === 0 ? "#d97706" : i === 1 ? "#94a3b8" : i === 2 ? "#b45309" : C.dim, fontSize: 14 }}>{i < 3 ? ["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i] : i + 1}</td>
                          <td style={{ padding: "10px 12px" }}>
                            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                              <div style={{ width: 24, height: 24, borderRadius: "50%", background: row.closer.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 10, fontWeight: 700, color: row.closer.color }}>{row.closer.name[0]}</div>
                              <span style={{ fontWeight: 600, color: C.text }}>{row.closer.name}</span>
                            </div>
                          </td>
                          <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600 }}>{row.r1}</td>
                          <td style={{ padding: "10px 8px", textAlign: "right", color: C.accent, fontWeight: 600 }}>{row.eff}</td>
                          <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: su != null ? (su >= 70 ? C.green : C.yellow) : C.muted }}>{su != null ? su.toFixed(0) + "%" : "â€”"}</td>
                          <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: row.deals > 0 ? C.green : C.muted }}>{row.deals || "â€”"}</td>
                          <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: cl != null ? (cl >= OBJECTIVES.tauxClosing ? C.green : C.red) : C.muted }}>{cl != null ? cl.toFixed(0) + "%" : "â€”"}</td>
                          <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: row.ca > 0 ? C.accent : C.muted }}>{row.ca > 0 ? euro(row.ca) : "â€”"}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
            </>
          );
        })()}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLOSING TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "closing" && <>

          {/* Global KPI Cards */}
          {(() => {
            const s = viewMode === "month" ? closingStats : viewMode === "week" ? weeklyClosingStats : dailyClosingStats;
            const sub = viewMode === "month" ? MONTHS[CURRENT_MONTH] : viewMode === "week" ? ("S" + selectedWeek + " Â· " + weekLabel) : dayLabel;
            return (
              <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))", gap: 12, marginBottom: 24 }}>
                <KPI label={viewMode === "month" ? "Total deals" : "Nouveaux deals"} value={num(s.totalR1)} color={C.blue} sub={sub} />
                <KPI label="R1 effectuÃ©s" value={num(s.totalEff)} color={C.accent} sub={sub} />
                <KPI label="Show-up" value={s.showUp != null ? s.showUp.toFixed(1) + "%" : "â€”"} color={C.yellow} />
                <KPI label="Deals signÃ©s" value={num(s.totalDeals)} color={C.green} sub={sub} />
                <KPI label="Taux closing" value={s.tauxClosing != null ? s.tauxClosing.toFixed(1) + "%" : "â€”"} color={(s.tauxClosing || 0) >= 20 ? C.green : C.red} />
                <KPI label="CA signÃ©" value={euro(s.totalCA || null)} color={C.accent} sub={sub} />
                <KPI label="Panier moyen" value={s.panierMoyen ? euro(s.panierMoyen) : "â€”"} color={C.cyan} />
                <KPI label="Pipe value" value={s.pipeValue > 0 ? euro(s.pipeValue) : "â€”"} color={C.purple} />
              </div>
            );
          })()}

          {/* Charts row (month mode only) */}
          {viewMode === "month" && <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
            {/* Chart: deals par closer */}
            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>Deals signÃ©s par closer â€” {MONTHS[CURRENT_MONTH]}</div>
              <ResponsiveContainer width="100%" height={200}>
                <BarChart data={closerChartData} layout="vertical">
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis type="number" tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} />
                  <YAxis type="category" dataKey="name" tick={{ fill: "#e2e8f0", fontSize: 11 }} axisLine={false} tickLine={false} width={80} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} />
                  <Bar dataKey="deals" radius={[0, 6, 6, 0]}>
                    {closerChartData.map((entry, i) => (
                      <Recharts.Cell key={i} fill={entry.color} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Chart: Ã©volution mensuelle par closer */}
            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>Ã‰volution des deals signÃ©s</div>
              <ResponsiveContainer width="100%" height={200}>
                <BarChart data={monthlyCloserData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis dataKey="name" tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} width={35} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} />
                  <Legend wrapperStyle={{ fontSize: 11, paddingTop: 4 }} />
                  {CLOSERS.map((c, i) => (
                    <Bar key={c.id} dataKey={c.name} stackId="a" fill={c.color}
                      radius={i === CLOSERS.length - 1 ? [4, 4, 0, 0] : [0, 0, 0, 0]} />
                  ))}
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>}

          {/* Closer cards / detail toggle */}
          <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 14, paddingBottom: 8, borderBottom: "1px solid " + C.border, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span>Performance par closer â€” {viewMode === "month" ? MONTHS[CURRENT_MONTH] : viewMode === "week" ? ("S" + selectedWeek + " Â· " + weekLabel) : dayLabel}</span>
            {viewMode === "month" && (
            <div style={{ display: "flex", gap: 4 }}>
              <button onClick={() => setCloserView("cards")} className={`view-btn ${closerView === "cards" ? "active" : ""}`}>RÃ©sumÃ©</button>
              <button onClick={() => setCloserView("detail")} className={`view-btn ${closerView === "detail" ? "active" : ""}`}>DÃ©tail mensuel</button>
            </div>
            )}
          </div>

          {(viewMode === "day" || viewMode === "week") ? (
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(240px, 1fr))", gap: 14, marginBottom: 24 }}>
              {CLOSERS.filter(c => {
                const src = viewMode === "week" ? weeklyClosingStats.closerData : dailyClosingStats.closerData;
                const cd = src[c.id];
                return cd && cd.newDeals > 0;
              }).map(c => {
                const src = viewMode === "week" ? weeklyClosingStats.closerData : dailyClosingStats.closerData;
                const cd = src[c.id];
                const eff = cd.r1 > 0 ? cd.r1 - cd.noshow : 0;
                const showUp = cd.r1 > 0 ? (eff / cd.r1 * 100) : null;
                const closing = eff > 0 ? (cd.won / eff * 100) : null;
                return (
                  <div key={c.id} style={{ background: C.card, borderRadius: 12, padding: "18px 20px", borderLeft: `4px solid ${c.color}`, minWidth: 0, boxShadow: C.cardShadow, border: "1px solid " + C.border }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
                      <div style={{ width: 32, height: 32, borderRadius: "50%", background: c.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, fontWeight: 700, color: c.color }}>{c.name[0]}</div>
                      <span style={{ fontSize: 15, fontWeight: 700, color: C.text }}>{c.name}</span>
                    </div>
                    <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 12px" }}>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Nouveaux</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: C.blue }}>{cd.newDeals}</div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R1</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: C.accent }}>{cd.r1}</div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>No Show</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: cd.noshow > 0 ? C.red : C.green }}>{cd.noshow}</div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R2</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: C.cyan }}>{cd.r2}</div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Won</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: cd.won > 0 ? C.green : C.muted }}>{cd.won || "â€”"}</div>
                      </div>
                      <div>
                        <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>CA</div>
                        <div style={{ fontSize: 20, fontWeight: 800, color: cd.ca > 0 ? C.accent : C.muted }}>{cd.ca > 0 ? euro(cd.ca) : "â€”"}</div>
                      </div>
                    </div>
                    <div style={{ display: "flex", gap: 16, marginTop: 8, paddingTop: 8, borderTop: "1px solid " + C.border }}>
                      <div style={{ fontSize: 10, color: C.dim }}>Show-up: <span style={{ fontWeight: 700, color: showUp != null ? (showUp >= 70 ? C.green : C.yellow) : C.muted }}>{showUp != null ? showUp.toFixed(0) + "%" : "â€”"}</span></div>
                      <div style={{ fontSize: 10, color: C.dim }}>Closing: <span style={{ fontWeight: 700, color: closing != null ? (closing >= 20 ? C.green : C.red) : C.muted }}>{closing != null ? closing.toFixed(0) + "%" : "â€”"}</span></div>
                      {cd.fu > 0 && <div style={{ fontSize: 10, color: C.dim }}>Follow-up: <span style={{ fontWeight: 700, color: C.orange }}>{cd.fu}</span></div>}
                    </div>
                  </div>
                );
              })}
              {(() => {
                const src = viewMode === "week" ? weeklyClosingStats.closerData : dailyClosingStats.closerData;
                const inactive = CLOSERS.filter(c => { const cd = src[c.id]; return !cd || cd.newDeals === 0; });
                return inactive.length > 0 ? (
                  <div style={{ background: "rgba(255,255,255,0.03)", borderRadius: 12, padding: "16px 18px", display: "flex", alignItems: "center", justifyContent: "center", border: "1px dashed " + C.border }}>
                    <span style={{ fontSize: 11, color: C.muted }}>{inactive.map(c => c.name).join(", ")} â€” pas d'activitÃ©</span>
                  </div>
                ) : null;
              })()}
            </div>
          ) : closerView === "cards" ? (
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(240px, 1fr))", gap: 14, marginBottom: 24 }}>
              {CLOSERS.map(c => <CloserCard key={c.id} closer={c} data={data.closing} mi={CURRENT_MONTH} />)}
            </div>
          ) : null}

          {viewMode === "month" && closerView === "detail" && (
            <div>
              {CLOSERS.map(c => (
                <div key={c.id} style={{ marginBottom: 28 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10, paddingLeft: 4 }}>
                    <div style={{ width: 26, height: 26, borderRadius: "50%", background: c.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 700, color: c.color }}>{c.name[0]}</div>
                    <span style={{ fontSize: 14, fontWeight: 700, color: c.color }}>{c.name}</span>
                    <span style={{ fontSize: 11, color: C.muted }}>{c.fullName}</span>
                  </div>
                  <MonthlyTable rows={closerRows} data={data.closing[c.id] || {}}
                    onCellChange={(key, mi, val) => updateClosing(c.id, key, mi, val)} />
                </div>
              ))}
            </div>
          )}
        </>}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SOURCES TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "sources" && <>

          {/* Source KPI Overview */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))", gap: 12, marginBottom: 24 }}>
            <KPI label="Total deals" value={num(186)} color={C.blue} sub="FÃ©v 2026 â€” Closing" />
            <KPI label="Deals signÃ©s" value={num(6)} color={C.green} sub="6 gagnÃ©s" />
            <KPI label="CA total" value={euro(26990)} color={C.accent} />
            <KPI label="Taux closing" value="12.8%" color={C.red} sub="6 / 47 eff." />
          </div>

          {/* Source comparison chart */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>Volume de deals par source</div>
              <ResponsiveContainer width="100%" height={200}>
                <BarChart data={CLOSING_SOURCES.map(s => ({ name: s, deals: CLOSING_BY_SOURCE[s].totalDeals, effectues: CLOSING_BY_SOURCE[s].r1Effectues, signes: CLOSING_BY_SOURCE[s].dealsSigne }))}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis dataKey="name" tick={{ fill: "#e2e8f0", fontSize: 11 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} width={35} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  <Bar dataKey="deals" name="Total deals" fill={C.blue} radius={[4, 4, 0, 0]} />
                  <Bar dataKey="effectues" name="R1 effectuÃ©s" fill={C.accent} radius={[4, 4, 0, 0]} />
                  <Bar dataKey="signes" name="SignÃ©s" fill={C.green} radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>CA signÃ© par source</div>
              <ResponsiveContainer width="100%" height={200}>
                <PieChart>
                  <Pie data={CLOSING_SOURCES.filter(s => CLOSING_BY_SOURCE[s].caSigne > 0).map(s => ({ name: s, value: CLOSING_BY_SOURCE[s].caSigne }))}
                    cx="50%" cy="50%" outerRadius={70} dataKey="value" label={({name, value}) => name + " " + euro(value)}>
                    {CLOSING_SOURCES.filter(s => CLOSING_BY_SOURCE[s].caSigne > 0).map((s, i) => (
                      <PieCell key={i} fill={CLOSING_SOURCE_COLORS[s]} />
                    ))}
                  </Pie>
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} formatter={(v) => euro(v)} />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* Source detail cards */}
          <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 14, paddingBottom: 8, borderBottom: "1px solid " + C.border }}>
            Performance par source d'acquisition â€” FÃ©v 2026
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(300px, 1fr))", gap: 14, marginBottom: 24 }}>
            {CLOSING_SOURCES.map(source => {
              const s = CLOSING_BY_SOURCE[source];
              const showUp = (s.r1Effectues + s.r1NoShow) > 0 ? (s.r1Effectues / (s.r1Effectues + s.r1NoShow) * 100) : null;
              const closing = s.r1Effectues > 0 ? (s.dealsSigne / s.r1Effectues * 100) : null;
              const convRate = s.totalDeals > 0 ? (s.dealsSigne / s.totalDeals * 100) : null;
              return (
                <div key={source} style={{ background: C.card, borderRadius: 12, padding: "18px 20px", borderLeft: `4px solid ${CLOSING_SOURCE_COLORS[source]}`, boxShadow: C.cardShadow, border: "1px solid " + C.border }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 14 }}>
                    <span style={{ fontSize: 20 }}>{CLOSING_SOURCE_EMOJI[source]}</span>
                    <div>
                      <div style={{ fontSize: 16, fontWeight: 700, color: C.text }}>{source}</div>
                      <div style={{ fontSize: 11, color: C.muted }}>{s.totalDeals} deals Â· {((s.totalDeals / 186) * 100).toFixed(0)}% du total</div>
                    </div>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "8px 12px" }}>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Total deals</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: C.text }}>{s.totalDeals}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R1 effectuÃ©s</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: C.accent }}>{s.r1Effectues}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>No Show</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: s.r1NoShow > 0 ? C.red : C.green }}>{s.r1NoShow}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>R2 bookÃ©s</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: C.cyan }}>{s.r2Bookes}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>SignÃ©s</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: s.dealsSigne > 0 ? C.green : C.muted }}>{s.dealsSigne || "â€”"}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Perdus</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: s.dealsPerdu > 0 ? C.red : C.muted }}>{s.dealsPerdu || "â€”"}</div>
                    </div>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, marginTop: 10, paddingTop: 10, borderTop: "1px solid " + C.border }}>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>CA signÃ©</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: s.caSigne > 0 ? C.accent : C.muted }}>{s.caSigne > 0 ? euro(s.caSigne) : "â€”"}</div>
                    </div>
                    <div>
                      <div style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", fontWeight: 600, letterSpacing: "0.04em" }}>Follow-ups</div>
                      <div style={{ fontSize: 20, fontWeight: 800, color: (s.fuCourt + s.fuLong) > 0 ? C.orange : C.muted }}>{s.fuCourt + s.fuLong || "â€”"}</div>
                    </div>
                  </div>
                  <div style={{ display: "flex", gap: 16, marginTop: 8, paddingTop: 8, borderTop: "1px solid " + C.border }}>
                    <div style={{ fontSize: 10, color: C.dim }}>Show-up: <span style={{ fontWeight: 700, color: showUp != null ? (showUp >= 70 ? C.green : C.yellow) : C.muted }}>{showUp != null ? showUp.toFixed(0) + "%" : "â€”"}</span></div>
                    <div style={{ fontSize: 10, color: C.dim }}>Closing: <span style={{ fontWeight: 700, color: closing != null ? (closing >= 20 ? C.green : C.red) : C.muted }}>{closing != null ? closing.toFixed(0) + "%" : "â€”"}</span></div>
                    <div style={{ fontSize: 10, color: C.dim }}>Conv: <span style={{ fontWeight: 700, color: convRate != null ? (convRate >= 5 ? C.green : C.red) : C.muted }}>{convRate != null ? convRate.toFixed(1) + "%" : "â€”"}</span></div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* Source pipeline funnel table */}
          <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 14, paddingBottom: 8, borderBottom: "1px solid " + C.border }}>
            Funnel de conversion par source
          </div>
          <div style={{ background: C.card, borderRadius: 12, border: "1px solid " + C.border, boxShadow: C.cardShadow, overflow: "hidden", marginBottom: 24 }}>
            <div style={{ overflowX: "auto" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
                <thead>
                  <tr style={{ background: "rgba(255,255,255,0.03)" }}>
                    <th style={{ padding: "10px 14px", textAlign: "left", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>Source</th>
                    {["Total", "No Show", "NS%", "R1 Eff.", "R2", "FU", "SignÃ©s", "Perdus", "CA", "Show-up", "Closing", "Conv."].map(h => (
                      <th key={h} style={{ padding: "10px 8px", textAlign: "right", fontWeight: 600, color: C.dim, fontSize: 10, textTransform: "uppercase", borderBottom: "1px solid " + C.border }}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {CLOSING_SOURCES.map((source, si) => {
                    const s = CLOSING_BY_SOURCE[source];
                    const showUp = (s.r1Effectues + s.r1NoShow) > 0 ? (s.r1Effectues / (s.r1Effectues + s.r1NoShow) * 100) : null;
                    const closing = s.r1Effectues > 0 ? (s.dealsSigne / s.r1Effectues * 100) : null;
                    const conv = s.totalDeals > 0 ? (s.dealsSigne / s.totalDeals * 100) : null;
                    const nsRate = s.totalDeals > 0 ? (s.r1NoShow / s.totalDeals * 100) : null;
                    return (
                      <tr key={source} style={{ borderBottom: si < CLOSING_SOURCES.length - 1 ? "1px solid rgba(255,255,255,0.06)" : "none" }}>
                        <td style={{ padding: "10px 14px", fontWeight: 700, color: CLOSING_SOURCE_COLORS[source] }}>{CLOSING_SOURCE_EMOJI[source]} {source}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700 }}>{s.totalDeals}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: s.r1NoShow > 0 ? C.red : C.green }}>{s.r1NoShow}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: nsRate > 15 ? C.red : C.green }}>{nsRate != null ? nsRate.toFixed(1) + "%" : "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: C.accent, fontWeight: 600 }}>{s.r1Effectues}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right" }}>{s.r2Bookes}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: C.orange }}>{s.fuCourt + s.fuLong}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: s.dealsSigne > 0 ? C.green : C.muted, fontWeight: 700 }}>{s.dealsSigne || "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: s.dealsPerdu > 0 ? C.red : C.muted }}>{s.dealsPerdu || "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: C.accent, fontWeight: 700 }}>{s.caSigne > 0 ? euro(s.caSigne) : "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: showUp != null ? (showUp >= 70 ? C.green : C.yellow) : C.muted, fontWeight: 600 }}>{showUp != null ? showUp.toFixed(0) + "%" : "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: closing != null ? (closing >= 20 ? C.green : C.red) : C.muted, fontWeight: 600 }}>{closing != null ? closing.toFixed(0) + "%" : "â€”"}</td>
                        <td style={{ padding: "10px 8px", textAlign: "right", color: conv != null ? (conv >= 5 ? C.green : C.red) : C.muted, fontWeight: 600 }}>{conv != null ? conv.toFixed(1) + "%" : "â€”"}</td>
                      </tr>
                    );
                  })}
                  <tr style={{ borderTop: "2px solid " + C.border, background: "rgba(255,255,255,0.03)" }}>
                    <td style={{ padding: "10px 14px", fontWeight: 800, color: C.text }}>TOTAL</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 800 }}>186</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 800, color: C.red }}>26</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700 }}>14.0%</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 800, color: C.accent }}>47</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700 }}>20</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: C.orange }}>13</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 800, color: C.green }}>6</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: C.red }}>6</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 800, color: C.accent }}>{euro(26990)}</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: C.yellow }}>64.4%</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: C.red }}>12.8%</td>
                    <td style={{ padding: "10px 8px", textAlign: "right", fontWeight: 700, color: C.red }}>3.2%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          {/* Key Insights */}
          <div style={{ background: C.card, borderRadius: 12, padding: 20, border: "1px solid " + C.border, boxShadow: C.cardShadow, marginBottom: 24 }}>
            <div style={{ fontSize: 14, fontWeight: 700, color: C.text, marginBottom: 12 }}>ðŸ’¡ Insights clÃ©s</div>
            <div style={{ display: "grid", gap: 8, fontSize: 12, color: C.dim }}>
              <div style={{ padding: "8px 12px", background: "rgba(52,211,153,0.08)", borderRadius: 8, borderLeft: "3px solid " + C.green }}>
                <strong style={{ color: C.green }}>Maformation</strong> â€” Source #1 en volume (57%) avec le <strong>meilleur taux de show-up (77%)</strong> et le plus faible no-show (7.7%). CA: 15 000 â‚¬
              </div>
              <div style={{ padding: "8px 12px", background: "rgba(129,140,248,0.08)", borderRadius: 8, borderLeft: "3px solid " + C.blue }}>
                <strong style={{ color: C.blue }}>Google</strong> â€” 26% des deals mais <strong>no-show Ã©levÃ© (19%)</strong>. Meilleur taux de conversion unitaire (4.3%). CA: 9 000 â‚¬
              </div>
              <div style={{ padding: "8px 12px", background: "rgba(168,85,247,0.08)", borderRadius: 8, borderLeft: "3px solid " + C.purple }}>
                <strong style={{ color: C.purple }}>Meta</strong> â€” Volume trÃ¨s faible (3 deals, 1.6%). Pas encore de vente. DonnÃ©es insuffisantes.
              </div>
            </div>
          </div>
        </>}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTING TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "setting" && <>

          {/* KPI Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))", gap: 12, marginBottom: 24 }}>
            <KPI label="Leads reÃ§us" value={num(settingStats.totalLeads)} color={C.blue} sub={MONTHS[CURRENT_MONTH]} />
            <KPI label="Leads qualifiÃ©s" value={num(settingStats.totalQualifies)} color={C.green} sub={MONTHS[CURRENT_MONTH]} />
            <KPI label="RDV bookÃ©s" value={num(settingStats.totalRdv)} color={C.accent} sub={MONTHS[CURRENT_MONTH]} />
            <KPI label="Appels totaux" value={num(settingStats.totalAppels)} color={C.cyan} sub={MONTHS[CURRENT_MONTH]} />
            <KPI label="Taux qualif." value={settingStats.tauxQualif != null ? settingStats.tauxQualif.toFixed(1) + "%" : "â€”"} color={C.yellow} />
            <KPI label="Taux prise RDV" value={settingStats.tauxRdv != null ? settingStats.tauxRdv.toFixed(1) + "%" : "â€”"} color={C.accent} />
            <KPI label="Temps rÃ©action" value={settingStats.avgReaction != null ? (settingStats.avgReaction < 60 ? settingStats.avgReaction + " min" : Math.floor(settingStats.avgReaction/60) + "h" + (settingStats.avgReaction%60 > 0 ? String(Math.round(settingStats.avgReaction%60)).padStart(2,"0") : "")) : "â€”"} color={settingStats.avgReaction != null ? (settingStats.avgReaction <= 300 ? C.green : settingStats.avgReaction <= 600 ? C.yellow : C.red) : C.muted} sub="MÃ©diane" />
          </div>

          {/* Charts row */}
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
            {/* Setter comparison */}
            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>Performance par setter â€” {MONTHS[CURRENT_MONTH]}</div>
              <ResponsiveContainer width="100%" height={180}>
                <BarChart data={setterChartData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis dataKey="name" tick={{ fill: "#e2e8f0", fontSize: 11 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} width={35} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  <Bar dataKey="leads" name="Leads" fill={C.blue} radius={[4, 4, 0, 0]} />
                  <Bar dataKey="qualifies" name="QualifiÃ©s" fill={C.green} radius={[4, 4, 0, 0]} />
                  <Bar dataKey="rdv" name="RDV" fill={C.accent} radius={[4, 4, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>

            {/* Monthly RDV by setter */}
            <div style={{ background: C.card, borderRadius: 12, padding: 18, border: "1px solid " + C.border, boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 13, fontWeight: 600, color: C.dim, marginBottom: 12 }}>RDV bookÃ©s par setter â€” Ã‰volution</div>
              <ResponsiveContainer width="100%" height={180}>
                <BarChart data={monthlySetterData}>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.06)" />
                  <XAxis dataKey="name" tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} />
                  <YAxis tick={{ fill: "#94a3b8", fontSize: 10 }} axisLine={false} tickLine={false} width={35} />
                  <Tooltip contentStyle={{ background: "#1e293b", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 8, fontSize: 11, color: "#f1f5f9", boxShadow: "0 4px 20px rgba(0,0,0,0.4)" }} />
                  <Legend wrapperStyle={{ fontSize: 11 }} />
                  {SETTERS.map((s, i) => (
                    <Bar key={s.id} dataKey={s.name} stackId="a" fill={s.color}
                      radius={i === SETTERS.length - 1 ? [4, 4, 0, 0] : [0, 0, 0, 0]} />
                  ))}
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* View toggle */}
          <div style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 14, paddingBottom: 8, borderBottom: "1px solid " + C.border, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span>DÃ©tail Setting â€” {MONTHS[CURRENT_MONTH]}</span>
            <div style={{ display: "flex", gap: 4 }}>
              <button onClick={() => setSettingView("setter")} className={`view-btn ${settingView === "setter" ? "active" : ""}`}>Par setter</button>
              <button onClick={() => setSettingView("source")} className={`view-btn ${settingView === "source" ? "active" : ""}`}>Par source</button>
            </div>
          </div>

          {/* Per setter view */}
          {settingView === "setter" && <>
            {/* Setter cards */}
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(320px, 1fr))", gap: 14, marginBottom: 24 }}>
              {SETTERS.map(s => <SetterCard key={s.id} setter={s} data={data.setting.bySetter[s.id]} mi={CURRENT_MONTH} />)}
            </div>

            {/* Setter detail tables */}
            {SETTERS.map(s => (
              <div key={s.id} style={{ marginBottom: 28 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10, paddingLeft: 4 }}>
                  <div style={{ width: 28, height: 28, borderRadius: "50%", background: s.color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, fontWeight: 700, color: s.color }}>{s.name[0]}</div>
                  <span style={{ fontSize: 14, fontWeight: 700, color: s.color }}>{s.name}</span>
                  <span style={{ fontSize: 11, color: C.muted }}>{s.fullName}</span>
                  <span style={{ fontSize: 10, color: C.dim, marginLeft: "auto", padding: "2px 8px", borderRadius: 4, background: "rgba(99,102,241,0.1)", border: "1px solid rgba(129,140,248,0.2)" }}>HubSpot: {s.leads} contacts</span>
                </div>
                <MonthlyTable rows={setterRows} data={data.setting.bySetter[s.id] || {}}
                  onCellChange={(key, mi, val) => updateSetter(s.id, key, mi, val)} />
              </div>
            ))}
          </>}

          {/* Per source view */}
          {settingView === "source" && <>
            {SOURCES.map(source => (
              <MonthlyTable key={source} title={source} titleColor={SOURCE_COLORS[source]} titleEmoji={SOURCE_EMOJI[source]}
                rows={settingSourceRows} data={data.setting.bySource[source] || {}}
                onCellChange={(key, mi, val) => updateSettingSource(source, key, mi, val)} />
            ))}
          </>}
        </>}

        {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PLANNING TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab === "planning" && <>

          {/* KPI Cards */}
          <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 16, marginBottom: 24 }}>
            {[
              { label: "Total RDV", value: planningStats.total, icon: "ðŸ“‹", color: C.accent },
              { label: "EffectuÃ©s", value: planningStats.completed, icon: "âœ…", color: C.green },
              { label: "No Show", value: planningStats.noShow, icon: "ðŸ”´", color: C.red },
              { label: "En attente", value: planningStats.scheduled, icon: "â³", color: C.yellow },
              { label: "Show-up %", value: planningStats.total > 0 ? planningStats.showUpRate.toFixed(1) + "%" : "â€”", icon: "ðŸ“ˆ", color: C.cyan },
            ].map((kpi, i) => (
              <div key={i} style={{ background: C.cardBg, borderRadius: 14, border: "1px solid " + C.border, padding: "18px 20px", boxShadow: C.cardShadow }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                  <span style={{ fontSize: 12, color: C.dim, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.5 }}>{kpi.label}</span>
                  <span style={{ fontSize: 18 }}>{kpi.icon}</span>
                </div>
                <div style={{ fontSize: 28, fontWeight: 800, color: kpi.color }}>{kpi.value}</div>
              </div>
            ))}
          </div>

          {/* Timeline visuelle par closer */}
          {planningStats.total > 0 ? (<>
            <div style={{ background: C.cardBg, borderRadius: 14, border: "1px solid " + C.border, padding: 24, marginBottom: 24, boxShadow: C.cardShadow, overflowX: "auto" }}>
              <h3 style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 20, display: "flex", alignItems: "center", gap: 8 }}>
                <span>ðŸ—“ï¸</span> Timeline des RDV â€” {planningDayLabel}
              </h3>
              {(() => {
                const hours = Array.from({ length: 12 }, (_, i) => i + 8); // 8h â†’ 19h
                const closerIds = CLOSERS.filter(c => planningStats.byCloser[c.id]).map(c => c.id);
                const OUTCOME_COLORS = {
                  SCHEDULED: { bg: "rgba(99,102,241,0.2)", border: "#818cf8" },
                  COMPLETED: { bg: "rgba(52,211,153,0.2)", border: "#34d399" },
                  NO_SHOW: { bg: "rgba(248,113,113,0.2)", border: "#f87171" },
                  CANCELLED: { bg: "rgba(100,116,139,0.2)", border: "#94a3b8" },
                  RESCHEDULED: { bg: "rgba(251,191,36,0.2)", border: "#fbbf24" },
                };
                const TYPE_EMOJI = { R1: "ðŸŸ£", R2: "ðŸ”µ", FU: "ðŸŸ¡" };
                const colW = 120; // width per hour column
                const rowH = 52;
                const labelW = 110;

                return (
                  <div style={{ position: "relative", minWidth: labelW + hours.length * colW }}>
                    {/* Hour headers */}
                    <div style={{ display: "flex", marginLeft: labelW, marginBottom: 4 }}>
                      {hours.map(h => (
                        <div key={h} style={{ width: colW, textAlign: "center", fontSize: 11, color: C.muted, fontWeight: 600 }}>{h}h</div>
                      ))}
                    </div>

                    {/* Rows per closer */}
                    {closerIds.map((cid, ri) => {
                      const closer = OWNER_MAP[cid] || {};
                      const closerMeetings = planningStats.byCloser[cid] || [];
                      return (
                        <div key={cid} style={{ display: "flex", alignItems: "center", height: rowH, borderTop: "1px solid " + C.border }}>
                          {/* Closer label */}
                          <div style={{ width: labelW, display: "flex", alignItems: "center", gap: 8, flexShrink: 0, paddingRight: 8 }}>
                            <div style={{ width: 28, height: 28, borderRadius: 8, background: closer.color || C.accent, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 12, fontWeight: 700, color: "#fff" }}>
                              {(closer.name || "?")[0]}
                            </div>
                            <span style={{ fontSize: 12, fontWeight: 600, color: C.text, whiteSpace: "nowrap" }}>{closer.name || cid}</span>
                          </div>
                          {/* Timeline track */}
                          <div style={{ position: "relative", flex: 1, height: "100%", display: "flex" }}>
                            {/* Grid background */}
                            {hours.map(h => (
                              <div key={h} style={{ width: colW, height: "100%", borderRight: "1px solid " + C.border, background: h % 2 === 0 ? "rgba(255,255,255,0.02)" : "transparent" }}></div>
                            ))}
                            {/* Meeting blocks */}
                            {closerMeetings.map((m, mi) => {
                              const [sh, sm] = m.start.split(":").map(Number);
                              const [eh, em_] = m.end.split(":").map(Number);
                              const startMin = (sh - 8) * 60 + sm;
                              const durMin = (eh - 8) * 60 + em_ - startMin;
                              const left = (startMin / 60) * colW;
                              const width = Math.max((durMin / 60) * colW - 4, 30);
                              const oc = OUTCOME_COLORS[m.outcome] || OUTCOME_COLORS.SCHEDULED;
                              return (
                                <div key={mi} title={`${m.start}-${m.end} | ${m.title} | ${m.type} | ${m.outcome}`}
                                  style={{
                                    position: "absolute", left, top: 6, height: rowH - 14, width,
                                    background: oc.bg, borderLeft: "3px solid " + oc.border, borderRadius: 6,
                                    display: "flex", alignItems: "center", gap: 4, padding: "0 6px", overflow: "hidden", cursor: "default",
                                  }}>
                                  <span style={{ fontSize: 10 }}>{TYPE_EMOJI[m.type] || "âšª"}</span>
                                  <span style={{ fontSize: 10, fontWeight: 600, color: C.text, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{m.title}</span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })}

                    {/* Legend */}
                    <div style={{ display: "flex", gap: 16, marginTop: 16, paddingLeft: labelW, flexWrap: "wrap" }}>
                      {[
                        { label: "En attente", color: "#818cf8" },
                        { label: "EffectuÃ©", color: "#34d399" },
                        { label: "No Show", color: "#f87171" },
                        { label: "ReportÃ©", color: "#fbbf24" },
                      ].map(l => (
                        <div key={l.label} style={{ display: "flex", alignItems: "center", gap: 6, fontSize: 11, color: C.dim }}>
                          <div style={{ width: 12, height: 12, borderRadius: 3, background: l.color + "33", borderLeft: "3px solid " + l.color }}></div>
                          {l.label}
                        </div>
                      ))}
                      <div style={{ marginLeft: 16, display: "flex", gap: 12 }}>
                        {[
                          { label: "R1", emoji: "ðŸŸ£" },
                          { label: "R2", emoji: "ðŸ”µ" },
                          { label: "Follow-up", emoji: "ðŸŸ¡" },
                        ].map(t => (
                          <span key={t.label} style={{ fontSize: 11, color: C.dim }}>{t.emoji} {t.label}</span>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* Liste dÃ©taillÃ©e par closer */}
            <h3 style={{ fontSize: 16, fontWeight: 700, color: C.text, marginBottom: 16, display: "flex", alignItems: "center", gap: 8 }}>
              <span>ðŸ‘¥</span> DÃ©tail par closer
            </h3>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(380px, 1fr))", gap: 16, marginBottom: 24 }}>
              {CLOSERS.filter(c => planningStats.byCloser[c.id]).map(closer => {
                const meetings = planningStats.byCloser[closer.id] || [];
                const done = meetings.filter(m => m.outcome === "COMPLETED").length;
                const ns = meetings.filter(m => m.outcome === "NO_SHOW").length;
                const wait = meetings.filter(m => m.outcome === "SCHEDULED").length;
                const OUTCOME_LABELS = { SCHEDULED: "â³ En attente", COMPLETED: "âœ… EffectuÃ©", NO_SHOW: "ðŸ”´ No Show", CANCELLED: "âŒ AnnulÃ©", RESCHEDULED: "ðŸ“… ReportÃ©" };
                const OUTCOME_STYLES = {
                  SCHEDULED: { bg: "rgba(99,102,241,0.1)", color: C.accent },
                  COMPLETED: { bg: "rgba(52,211,153,0.1)", color: C.green },
                  NO_SHOW: { bg: "rgba(248,113,113,0.1)", color: C.red },
                  CANCELLED: { bg: "rgba(100,116,139,0.1)", color: C.muted },
                  RESCHEDULED: { bg: "rgba(251,191,36,0.1)", color: C.yellow },
                };
                const TYPE_EMOJI = { R1: "ðŸŸ£", R2: "ðŸ”µ", FU: "ðŸŸ¡" };

                return (
                  <div key={closer.id} style={{ background: C.cardBg, borderRadius: 14, border: "1px solid " + C.border, padding: 20, boxShadow: C.cardShadow }}>
                    {/* Header */}
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 14 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                        <div style={{ width: 36, height: 36, borderRadius: 10, background: closer.color, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, fontWeight: 700, color: "#fff" }}>
                          {closer.name[0]}
                        </div>
                        <div>
                          <div style={{ fontSize: 15, fontWeight: 700, color: C.text }}>{closer.name}</div>
                          <div style={{ fontSize: 11, color: C.dim }}>{meetings.length} RDV</div>
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6 }}>
                        {done > 0 && <span style={{ fontSize: 11, fontWeight: 600, padding: "3px 8px", borderRadius: 6, background: "rgba(52,211,153,0.15)", color: C.green }}>{done} âœ…</span>}
                        {ns > 0 && <span style={{ fontSize: 11, fontWeight: 600, padding: "3px 8px", borderRadius: 6, background: "rgba(248,113,113,0.15)", color: C.red }}>{ns} ðŸ”´</span>}
                        {wait > 0 && <span style={{ fontSize: 11, fontWeight: 600, padding: "3px 8px", borderRadius: 6, background: "rgba(99,102,241,0.15)", color: C.accent }}>{wait} â³</span>}
                      </div>
                    </div>
                    {/* Meeting list */}
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {meetings.map((m, mi) => {
                        const os = OUTCOME_STYLES[m.outcome] || OUTCOME_STYLES.SCHEDULED;
                        return (
                          <div key={mi} style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 10px", borderRadius: 8, background: "rgba(255,255,255,0.03)", border: "1px solid " + C.border }}>
                            <span style={{ fontSize: 12, fontWeight: 700, color: C.accent, fontVariantNumeric: "tabular-nums", minWidth: 42 }}>{m.start}</span>
                            <span style={{ fontSize: 12, color: C.text, flex: 1, fontWeight: 500 }}>{m.title}</span>
                            <span style={{ fontSize: 10 }}>{TYPE_EMOJI[m.type] || "âšª"} {m.type}</span>
                            <span style={{ fontSize: 10, fontWeight: 600, padding: "2px 7px", borderRadius: 5, background: os.bg, color: os.color, whiteSpace: "nowrap" }}>
                              {OUTCOME_LABELS[m.outcome] || m.outcome}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </>) : (
            <div style={{ background: C.cardBg, borderRadius: 14, border: "1px solid " + C.border, padding: "60px 24px", textAlign: "center", boxShadow: C.cardShadow }}>
              <div style={{ fontSize: 48, marginBottom: 12 }}>ðŸ“…</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: C.text, marginBottom: 8 }}>Pas de donnÃ©es pour {planningDayLabel}</div>
              <div style={{ fontSize: 13, color: C.dim }}>Naviguez vers un autre jour avec les flÃ¨ches â—€ â–¶</div>
            </div>
          )}
        </>}

      </main>

      <footer style={{ textAlign: "center", padding: "20px 0 24px", fontSize: 11, color: C.muted, borderTop: "1px solid " + C.border }}>
        studeria â€” work with AI
      </footer>
    </div>
  );
}

try {
  ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);
} catch(e) {
  document.getElementById("root").innerHTML = '<div style="padding:40px;color:red"><h2>Erreur</h2><pre>' + e.message + '\n' + e.stack + '</pre></div>';
}
</script>
</body>
</html>
